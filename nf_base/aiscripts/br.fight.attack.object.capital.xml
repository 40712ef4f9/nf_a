<?xml version="1.0" encoding="iso-8859-1" ?>
<aiscript name="BR.fight.attack.object.capital" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="3">
  <!--

  Capital ship (defense officer NPC) vs Object (any class)
  by Adrian

  Attack of a capital ship (made by defense noc), to enemys in weapon range
  Set turrets and launch drones
  Not movement: see 'move.attack.object.capital'

  Optional target (object) as a parameter.
  Optional endwheninactive, to finish when there are no enemies.

  -->
  <params>
    <param name="target" default="null"/>
    <param name="allowothertargets" default="true" comment="Whether the script shall keep running when primary target have been destroyed (ignore if not target provided)" />
    <param name="checkrelation" default="true" />
    <param name="debugoutputchance" default="0"/>
  </params>
  <interrupts>
    <handler>
      <conditions>
        <check_any>
          <check_all>
            <event_object_attacked object="this.ship"/>
            <check_value value="event.param.isoperational"/>
            <check_value value="event.param and (event.param.isclass.defensible or event.param.defensible.exists)"/>
            <check_value value="this.ship.mayattack.{event.param}" />
            <check_value value="not $attackers.indexof.{event.param} and not $enemies.indexof.{event.param}" />
          </check_all>
          <check_all>
            <event_gravidar_has_scanned object="this.ship" />
            <check_value value="this.ship.attention ge attention.visible" />
            <check_value value="not $attackint? or ($attackint? and $attackint lt player.age)" />
            <count_gravidar_contacts result="$close_targets" object="this.ship" class="[class.ship_l, class.ship_xl, class.ship_s, class.ship_m, class.station]" mayattack="this.ship" min="1">
              <match_distance object="this.ship" max="6km"/>
            </count_gravidar_contacts>
          </check_all>
        </check_any>
      </conditions>
      <actions>
        <!--Get the top-level defensible of the attacker in low attention case-->
        <do_if value="event.name" exact="'event_object_attacked'">
          <debug_text text="'event_object_attacked: ' + this.ship.knownname" chance="$debugoutputchance"/>
          <set_value name="$counterstrike" exact="100"/>
          <!--uncover if no real enemy-->
          <set_value name="$notEnemy" exact="if event.param and event.param.owner.hasrelation.enemy.{this.ship.trueowner} then false else true"/>
          <do_if value="this.ship.owner != this.ship.trueowner and ($notEnemy or this.ship.shieldpercentage lt 20)">
            <set_value name="$counterstrike" exact="0" chance="if event.param and event.param.owner.hasrelation.enemy.{this.ship.trueowner} then 0 else 100"/>
            <get_control_entities groupname="$Entities" object="this.ship"/>
            <do_all exact="$Entities.count" counter="$j" >
              <set_cover_owner object="$Entities.{$j}"/>
            </do_all>
            <set_cover_owner object="this.ship"/>
            <remove_value name="$Entities"/>
          </do_if>
          <remove_value name="$notEnemy"/>
          <!--keep calm-->
          <do_if value="$target and $target != event.param and event.param.relationto.{this.ship.owner} lt event.param.owner.relationto.{this.ship.owner} and not event.param.trueowner.hasrelation.enemy.{this.ship.trueowner}"
            chance="if this.ship.attention ge attention.visible and event.param and event.param.isclass.[class.ship_l, class.ship_xl, class.station] then 100 else 0">
            <set_value name="$negrelation" exact="if event.param.relationto.{this.ship} lt this.owner.relation.neutral.min then event.param.relationto.{this.ship} else null" />
            <do_if value="$negrelation">
              <add_relation_boost object="event.param" otherobject="this" value="this.owner.relation.neutral.mid - $negrelation" decay="1" delay="30min" silent="true" />
              <set_value name="$counterstrike" exact="0" />
            </do_if>
            <remove_value name="$negrelation"/>
          </do_if>
          <!--this is sparta-->
          <set_value name="$attacker" exact="null"/>
          <do_if value="event.param and typeof event.param == datatype.component" chance="$counterstrike">
            <set_value name="$thiscombinedskill" exact="this.combinedskill"/>
            <set_value name="$doAttackenemies" exact="this.ship.owner == this.ship.trueowner and (@this.$config_attackenemies == 1  or (not this.ship.isplayerowned and not this.$config_attackenemies?))"/>
            <set_value name="$attacker" exact="if event.param.isclass.defensible then event.param else event.param.defensible"/>
            <add_to_group groupname="$attackers" object="$attacker"/>
            <do_if value="$attacker.commander or $attacker.subordinates.count" chance="if not $doAttackenemies and $thiscombinedskill gt 70 then 100 else 0">
              <do_if value="$attacker.commander and $attacker.commander.isclass.ship and not $attackers.indexof.{$attacker} and this.mayattack.{$attacker} and this.ship.zone == $attacker.commander.zone">
                <add_to_group groupname="$attackers" object="$attacker.commander"/>
              </do_if>
              <do_if value="$attacker.subordinates.count">
                <do_all exact="$attacker.subordinates.count" counter="$j" >
                  <do_if value="not $attackers.indexof.{$attacker.subordinates.{$j}} and $attacker.subordinates.{$j}.isclass.ship and this.mayattack.{$attacker.subordinates.{$j}} and this.ship.zone == $attacker.subordinates.{$j}.zone">
                    <add_to_group groupname="$attackers" object="$attacker.subordinates.{$j}"/>
                  </do_if>
                </do_all>
              </do_if>
            </do_if>
          </do_if>
          <debug_text text="' %1 attention. add attacker %2 (%3) to $attackers (%4) | enemies %5.'.[this.ship.attention, $attacker.knownname, $attacker, $attackers.count, $enemies.count]" chance="$debugoutputchance" />
          <remove_value name="$counterstrike"/>
        </do_if>
        <!-- Only break the current blocking high attention -->
        <do_if value="this.ship.attention ge attention.visible">
          <set_value name="$attackint" exact="player.age + 10s"/>
          <abort_called_scripts resume="FindEnemies" />
        </do_if>
      </actions>
    </handler>
    <handler>
      <conditions>
        <event_object_jump_completed  object="this.ship" />
        <check_value value="this.attention ge attention.visible" />
        <check_value value="this.combinedskill ge 70" />
      </conditions>
      <actions>
        <set_value name="$nextenemycheck" exact="player.age"/>
        <abort_called_scripts resume="FindEnemies" />
      </actions>
    </handler>
    <handler>
      <conditions>
        <check_any>
          <check_all>
            <event_object_changed_owner group="$targets" />
            <check_value value="event.object.exists and not event.param.hasrelation.enemy.{this.ship.owner}"/>
          </check_all>
          <check_all>
            <event_object_signalled object="this.ship" param="'update enemies'" />
            <check_value value="event.param2? and typeof event.param2 == datatype.faction and not event.param2.hasrelation.enemy.{this.ship.owner}"/>
          </check_all>
        </check_any>
      </conditions>
      <actions>
        <cease_fire object="this.ship" weapontype="combat"/>
        <clear_group group="$targets" chance="if $targets? then 100 else 0"/>
        <clear_group group="$dronetargets" chance="if $dronetargets? then 100 else 0"/>
        <clear_group group="$targetsInSight" chance="if $targetsInSight? then 100 else 0"/>
        <clear_group group="$validbigguntarget" chance="if $validbigguntarget? then 100 else 0"/>
        <!-- Remove the target to stop shooting at it, when owner changes -->
        <set_value name="$target" exact="null" chance="if event.name == 'event_object_changed_owner' then 100 else 0"/>
        <set_value name="$nextenemycheck" exact="player.age + player.timewarp.factor*3"/>
        <abort_called_scripts resume="finish"/>
      </actions>
    </handler>
    <handler>
      <conditions>
        <event_object_incoming_missile  object="this.ship" />
        <check_value value="this.attention ge attention.visible" />
        <check_value value="this.combinedskill ge 90" />
      </conditions>
      <actions>
        <do_if value="this.$missiles?" negate="true">
          <create_group groupname="this.$missiles" />
        </do_if>
        <add_to_group groupname="this.$missiles" object="event.param2" />
        <do_if value="not $intercept? or ($intercept? and $intercept lt player.age)" chance="if this.ship.subordinates.count then 100 else 0">
          <signal_objects object="this.ship" param="'intercept missile'"/>
          <set_value name="$intercept" exact="player.age+player.timewarp.factor*2" />
        </do_if>
      </actions>
    </handler>
    <handler>
      <conditions>
        <event_object_signalled object="this.ship" param="'update targets'" />
        <check_value value="@this.$dronetargetsShare" />
      </conditions>
      <actions>
        <do_if value="$dronetargets.list.count and event.param2.exists">
          <signal_objects object="event.param2" param="'update targets'" param2="$dronetargets.list" />
        </do_if>
        <do_else>
          <remove_value name="this.$dronetargetsShare" />
        </do_else>
      </actions>
    </handler>
    <handler>
      <conditions>
        <event_object_signalled object="this.ship" param="'intercept missile'" />
      </conditions>
      <actions>
        <create_group groupname="$interceptors" />
        <do_all exact="this.ship.subordinates.count" counter="$f" >
          <do_if value="this.ship.subordinates.{$f}.macro.ismacro.[macro.units_size_drone_attackdrone_impulse_mk1_macro, macro.units_size_drone_attackdrone_impulse_mk2_macro, macro.units_size_drone_attackdrone_plasma_mk1_macro, macro.units_size_drone_attackdrone_plasma_mk2_macro]">
            <add_to_group groupname="$interceptors" object="this.ship.subordinates.{$f}" />
          </do_if>
        </do_all>
        <set_value name="$tmp_missile" exact="this.ship.defencenpc.$missiles.list.clone"/>
        <do_all exact="$tmp_missile.count" counter="$f" reverse="true">
          <do_if value="$tmp_missile.{$f}.exists" negate="true">
            <do_if value="$tmp_missile.{$f}">
              <remove_from_group group="this.ship.defencenpc.$missiles" object="$tmp_missile.{$f}" />
            </do_if>
            <remove_value name="$tmp_missile.{$f}" />
          </do_if>
        </do_all>
        <do_if value="$tmp_missile.count">
          <signal_objects group="$interceptors" param="'intercept missile'" />
        </do_if>
        <remove_value name="$tmp_missile" />
        <remove_value name="$interceptors" />
      </actions>
    </handler>
  </interrupts>
  <init>
    <!-- Command on defense officer-->
    <set_command command="command.attackenemies" />
    <!-- initial variables -->
    <set_value name="$lastdronelaunch" exact="player.age - 500s" />
    <set_value name="$nextammocheck" exact="player.age + 100s" />
    <set_value name="$nextenemycheck" exact="player.age"/>
    <set_value name="$FiringRange" exact="this.ship.maxcombatrange.all"/>
    <create_group groupname="$attackers"/>
    <create_group groupname="$targets" />
    <create_group groupname="$dronetargets" />
    <create_list name="$enemies" />
  </init>
  <patch sinceversion="3" early="true">
    <do_if value="$targets?" negate="true">
      <create_group groupname="$targets" />
    </do_if>
  </patch>
  <attention min="visible">
    <actions>

      <debug_text text="'Firing range for: ' + this.ship.knownname + ' is: ' + $FiringRange" chance="$debugoutputchance"/>

      <label name="FindEnemies" />
      <set_value name="$thiscombinedskill" exact="this.combinedskill"/>
      <set_value name="$doAttackenemies" exact="this.ship.owner == this.ship.trueowner and (@this.$config_attackenemies == 1  or (not this.ship.isplayerowned and not this.$config_attackenemies?))"/>
      <set_value name="$doAllowothertargets" exact="$doAttackenemies and $allowothertargets"/>

      <do_if value="$target.exists and not @$target.isclass.defensible and @$target.container.isclass.defensible">
        <set_value name="$target" exact="$target.container" />
      </do_if>
      <!-- Only update enemies with some delay -->
      <do_if value="player.age ge $nextenemycheck">
        <!--TODO: Based on skill?-->
        <set_value name="$skillpower" exact="$thiscombinedskill"/>
        <set_value name="$skillpower" exact="this.ship.pilot.combinedskill" operation="add" chance="this.ship.pilot.exists*100"/>
        <set_value name="$skillpower" exact="this.ship.engineer.combinedskill" operation="add" chance="this.ship.engineer.exists*100"/>
        <set_value name="$skillpower" exact="if $skillpower gt 3 then $skillpower / 3 else $skillpower"/>
        <set_value name="$temp" exact="100 - $thiscombinedskill" comment="100 - (0-100)"/>
        <set_value name="$nextenemycheck" min="player.age + 10s" max=" player.age + [(20*player.timewarp.factor + $temp*1s), 240s].min"/>
        <remove_value name="$temp" />

        <!-- Create/clean list of enemies -->
        <create_list name="$enemies" />

        <!-- Find (more) enemies if no target or other targets are allowed -->
        <do_if value="(not $target and $doAttackenemies) or @$doAllowothertargets or (@$close_targets and $doAttackenemies)">
          <remove_value name="$close_targets" />
          <find_gravidar_contact name="$enemies" object="this.ship" functional="true" maybeattackedby="this.ship" multiple="true">
            <match_distance object="this.ship" max="$FiringRange"/>
          </find_gravidar_contact>
        </do_if>

        <!-- Main target (parameter) -->
        <do_if value="$target.isoperational">
          <do_if value="(this.ship.mayattack.{$target} or not $checkrelation) and not @$target.dockslot" comment="check relation of ship (not defense NPC)" >
            <debug_text text="'Prefered target of: ' + this.ship.knownname + ' is: ' + $target.knownname" chance="$debugoutputchance"/>
            <!--check if target is already in list of enemies-->
            <do_if value="not $enemies.indexof.{$target}">
              <append_to_list name="$enemies" exact="$target" />
            </do_if>
          </do_if>
          <do_else>
            <!-- Target is not an enemy anymore -->
            <set_value name="$target" exact="null" />
          </do_else>
        </do_if>

        <do_if value="$targets?" negate="true">
          <create_group groupname="$targets" />
        </do_if>
        <do_if value="$dronetargets?" negate="true">
          <create_group groupname="$dronetargets" />
        </do_if>
      </do_if>

      <!-- include attackers -->
      <do_all exact="$attackers.count" counter="$i">
        <do_if value="not $enemies.indexof.{$attackers.{$i}} and this.ship.mayattack.{$attackers.{$i}}">
          <append_to_list name="$enemies" exact="$attackers.{$i}" />
        </do_if>
      </do_all>
      <clear_group group="$attackers"/>

      <!-- ************************ Modified code from vanilla, start ************************ -->
      <!--
        Bonus calculation based on skill works like this:
        Base bonus: 10
        Max: 10+5+5 = 20 (combat*2+leadership+morale)
        Max total: 30
        Min total: 10
        NB: Do not increase basevalue without changing the dronelaunch delay hack in the end of script.
        Calculating baseskill:-->
      <set_value name="$DObaseskill" exact="10 + @this.defensible.defencenpc.skill.combat * 2 + @this.defensible.defencenpc.skill.leadership + @this.defensible.defencenpc.skill.morale" />
      <set_value name="$LRShip" exact="global.$MICT_LR_Ships? and this.ship.macro.ismacro.{global.$MICT_LR_Ships}" />
      <set_value name="$targetIsStation" exact="if $target and $target.isclass.station then true else false" />
      <!--<set_value name="$DObaseskill" exact="30"/>-->

      <!--<debug_text text="player.age + '%1 DO skill calculation: combat: %2*2, leadership: %3, morale: %4, baseskill calculated to: %5'.[this.ship.name, this.defensible.defencenpc.skill.combat, this.defensible.defencenpc.skill.leadership, this.defensible.defencenpc.skill.morale, $DObaseskill]" chance="100" filter="general" />-->
      <!--Calculate droneswarm size, max 10 for L/LX and light/heavy suls-->
      <do_if value="this.ship.isclass.ship_xl or this.ship.macro.ismacro.[macro.units_size_l_kit_carrier_01_macro, macro.units_size_l_kit_carrier_02_macro]">
        <set_value name="$droneswarmsize"  exact="$DObaseskill / 3" />
      </do_if>
      <do_else>
        <!-- halve the drone swarm size for all L ships exept suls handled above-->
        <set_value name="$droneswarmsize"  exact="($DObaseskill / 3) / 2" />
      </do_else>

      <!-- ok, we have found enemies, let's do something about them -->
      <do_if value="$enemies.count" min="1">
        <!--Adding/resetting extra needed variables for target priority and rangechecks-->
        <set_value name="$prioTarget" exact="null"/>
        <!--set_value name="$closestTarget" exact="null"/-->
        <create_group groupname="$targetsInSight"/>
        <create_group groupname="$validbigguntarget"/>


        <!-- Simulate the attack -->
        <set_command_action commandaction="commandaction.attacking" />

        <activate_battlestate object="this.ship" state="battlestate_red" />
        <!--<activate_flaks object="this.ship" />-->
        <set_value name="this.$combat_active" exact="player.age" />

        <!--If wingman, check and adapt leader DO's combat state-->
        <do_if value="@this.ship.commander.exists and @this.ship.commandertype == entitytype.commander and this.ship.isplayerowned == true">
          <set_value name="this.$config_attackenemies" exact="@this.ship.commander.defencenpc.$config_attackenemies" />
          <do_if value="@this.$config_attackenemies == 1">
            <set_value name="$allowothertargets" exact="true"/>
          </do_if>
          <do_else>
            <set_value name="$allowothertargets" exact="false"/>
          </do_else>
        </do_if>

        <do_all counter="$i" exact="$enemies.count">
          <do_if value="$enemies.{$i}.isoperational">
            <do_if value="$enemies.{$i}.isclass.[class.ship, class.station] and $enemies.{$i}.boarder and @this.ship.relationto.{$enemies.{$i}.boarder} ge 0 and $enemies.{$i}.hullpercentage le 70 and this.ship.shieldpercentage ge 20">
              <continue />
            </do_if>
            <!--Get random bonus to skill calculations-->
            <set_value name="$DOskillcheckbonus" min="0" max="10" />
            <!-- fail detecting enemy if skill level too low-->
            <do_if value="($DObaseskill + $DOskillcheckbonus) gt 19" comment="PRO and 1337 Version">
              <!--Add to drone targetlist if valid target, masstraffic included. Avoids stations and L/XL here -->
              <do_if value="$enemies.{$i}.isclass.[class.ship_xs, class.ship_s, class.ship_m]">
                <!--Don't let drones wander too far off-->
                <do_if value="this.ship.distanceto.{$enemies.{$i}}" max="10000m">
                  <add_to_group groupname="$dronetargets" object="$enemies.{$i}" />
                </do_if>
                <!-- Generating targets list, LOS check pr. enemy, potential expensive stuff.. -->
                <add_to_group groupname="$targets" object="$enemies.{$i}"/>
                <!--TODO: LOS might be a bit overkill here. consider removing-->
                <set_value name="$result" exact="true"/>
                <check_line_of_sight name="$result" object="this.ship" target="$enemies.{$i}" chance="if $thiscombinedskill gt 75 then 100 else 0"/>
                <!--find closest target with LOS. set as prioritized in case $i is closest or first one-->
                <do_if value="$result">
                  <add_to_group groupname="$targets" object="$enemies.{$i}" />
                  <!--adding skunk as valid target for IHC/torpedoes for NPC's if they have LOS-->
                  <do_if value="$enemies.{$i} == @player.primaryship">
                    <add_to_group groupname="$validbigguntarget" object="$enemies.{$i}"/>
                  </do_if>
                </do_if>
                <remove_value name="$result" />
              </do_if>
              <do_elseif value="$enemies.{$i}.isclass.[class.ship_xl, class.ship_l]">
                <check_line_of_sight name="$result" object="this.ship" target="$enemies.{$i}"/>
                <do_if value="$result">
                  <set_value name="$droneRange" exact="if this.ship.distanceto.{$enemies.{$i}} le 10km then true else false" />
                  <set_value name="$droneShould" exact="if $enemies.{$i}.primarypurpose == objectpurpose.fight then false else true" />
                  <find_object_component object="$enemies.{$i}" groupname="$targetComps" surfaceelement="true" multiple="true" invulnerable="false" functional="true" integrated="false"/>
                  <do_all exact="$targetComps.list.count" counter="$j">
                    <do_if value="$targetComps.list.{$j}? and not $targetComps.list.{$j}.iswreck">
                      <continue />
                    </do_if>
                    <!-- fail detecting component if skill level too low. 30 is 5 star basevalue with 0 random bonus. Getting new random number-->
                    <set_value name="$DOskillcheckbonus" min="0" max="10" />
                    <do_if value="($DObaseskill + $DOskillcheckbonus) gt 29">
                      <!--TODO: Probably not complete item list. Prioritized surface elements (ignoring shieldgens, waste of time)-->
                      <do_if value="$targetComps.list.{$j}.isclass.[class.turret, class.jumpdrive, class.engine, class.launcher]">
                        <!-- LOS only for the whole enemy, turrets won't shoot at something they don't see -->
                        <set_value name="$result" exact="false"/>
                        <check_line_of_sight name="$result" object="this.ship" target="$targetComps.list.{$j}" chance="if not $targetIsStation and $thiscombinedskill ge 75 then 100 else 0"/>
                        <add_to_group groupname="$targetsInSight" object="$targetComps.list.{$j}" chance="if $result then 100 else 0"/>
                        <add_to_group groupname="$dronetargets" object="$targetComps.list.{$j}" chance="if $result or not $droneShould or not $droneRange or $targetComps.list.{$j}.isclass.turret then 0 else 100"/>
                        <add_to_group groupname="$targets" object="$targetComps.list.{$j}"/>
                        <!--Adding LOS targets as valid for big guns for offensive DO + NPC-->
                        <do_if value="$doAttackenemies or ($target == $enemies.{$i} and not $enemies.{$i}.boarder)" chance="if $enemies.{$i}.isclass.[class.ship, class.station] then 100 else 0">
                          <add_to_group groupname="$validbigguntarget" object="$targetComps.list.{$j}"/>
                        </do_if>
                      </do_if>
                      <!--Adding LOS targets of opportunity for an offensive DO and NPC's. Also valid for big guns-->
                      <do_elseif value="$targetComps.list.{$j}.isclass.[class.dronelaunchpad, class.radar]">
                        <do_if value="$doAttackenemies or ($target == $enemies.{$i} and not $enemies.{$i}.boarder)">
                          <set_value name="$result" exact="false"/>
                          <check_line_of_sight name="$result" object="this.ship" target="$targetComps.list.{$j}" chance="if not $targetIsStation and $skillpower ge 75 then 100 else 0"/>
                          <add_to_group groupname="$targetsInSight" object="$targetComps.list.{$j}" chance="if $result then 100 else 0"/>
                          <add_to_group groupname="$targets" object="$targetComps.list.{$j}" />
                          <add_to_group groupname="$validbigguntarget" object="$targetComps.list.{$j}"/>
                          <add_to_group groupname="$dronetargets" object="$targetComps.list.{$j}" chance="if $result or not $droneShould or not $droneRange then 0 else 100"/>
                        </do_if>
                      </do_elseif>
                    </do_if>
                  </do_all>
                  <remove_value name="$droneShould" />
                  <remove_value name="$droneRange" />
                </do_if>
                <remove_value name="$targetComps" />
                <remove_value name="$result" />
                <!--Only do intentional targetting of hull if defence officer is in offensive mode or this is a NPC ship. Also send out drones + shoot IHC/torpedoes for sucellus/balor -->
                <do_if value="$doAttackenemies or ($target == $enemies.{$i} and not $enemies.{$i}.boarder)">
                  <add_to_group groupname="$targets" object="$enemies.{$i}" />
                  <add_to_group groupname="$validbigguntarget" object="$enemies.{$i}"/>
                  <do_if value="this.ship.distanceto.{$enemies.{$i}} lt 10000m" chance="100-[$skillpower-this.ship.shieldpercentage,0].max">
                    <add_to_group groupname="$dronetargets" object="$enemies.{$i}" />
                  </do_if>
                </do_if>
              </do_elseif>
              <do_elseif value="$enemies.{$i}.isclass.station">
                <!-- find and prioritize LOS station weapons -->
                <find_object_component object="$enemies.{$i}" groupname="$targetComps" class="[class.turret, class.weapon, class.launcher]" surfaceelement="true" multiple="true" checkoperational="true" invulnerable="false" integrated="false"/>
                <set_value name="$tmpWeapons" exact="$targetComps.list" />
                <do_if value="$targetComps.list.count and $thiscombinedskill lt 80">
                  <add_to_group groupname="$targets" list="$targetComps.list"/>
                </do_if>
                <do_else>
                  <do_all exact="$targetComps.list.count" counter="$j">
                    <do_if value="$targetComps.list.{$j}? and not $targetComps.list.{$j}.iswreck">
                      <continue />
                    </do_if>
                    <add_to_group groupname="$targets" object="$targetComps.list.{$j}"/>
                    <do_if value="$targetComps.list.{$j}.isclass.launcher">
                      <add_to_group groupname="$dronetargets" object="$enemies.{$i}" />
                    </do_if>
                    <!--add_to_group groupname="$validbigguntarget" object="$targetComps.list.{$j}" chance="0"/>
                    <set_value name="$result" exact="false"/>
                    <check_line_of_sight name="$result" object="this.ship" target="$targetComps.list.{$j}" chance="if not $targetIsStation and $thiscombinedskill ge 80 then 100 else 0"/>
                    <add_to_group groupname="$targetsInSight" object="$targetComps.list.{$j}" chance="if $result then 100 else 0"/-->
                    <wait exact="player.timewarp.factor/100" sinceversion="2" chance="player.timewarp.active*100" />
                  </do_all>
                </do_else>
                <!--add station hull parts as valid targets of opportunity for offensive DO/NPC. Big targets, dont have skillchecks here -->

                <!-- NPC TroopShips station disable mode (remember: just for attention visible)-->
                <!--this ship is NPC and the target is a station that is being boarded by friends or ... -->
                <!--this ship is NPC and this zone have friendly troopships or ... -->
                <!--this ship is NPC and the station hull is ge 95% and yet have guns or ... -->
                <!--this ship is a troopship itself -->
                <!--then dont target the station hull, just the guns-->
                <do_if value="this.ship.macro.ismacro.{global.$boardingvessel_cap}" chance="if $TroopShip? then 0 else 100">
                  <set_value name="$TroopShip" exact="this.ship" />
                </do_if>
                <find_ship name="$TroopShip" functional="true" space="$enemies.{$i}.zone" multiple="false" chance="if $TroopShip? then 0 else 100">
                  <match_any>
                    <match macro="macro.units_size_l_troop_transporter1_macro"/>
                    <match macro="macro.units_size_l_troop_transporter5_macro"/>
                    <match macro="macro.units_size_m_boarding_macro"/>
                  </match_any>
                  <match_relation faction="this.ship.owner" relation="neutral" comparison="ge" />
                </find_ship>

                <set_value name="$boardingFlag" exact="if $TroopShip or ($enemies.{$i}.boarder and @this.ship.relationto.{$enemies.{$i}.boarder} ge 0) then true else false" />

                <do_if value="@this.$config_attackenemies == 1 and not $boardingFlag" chance="if $enemies.{$i} == $target then 0 else 100">
                  <clear_group group="$targetComps"/>
                  <!--<find_object_component object="$enemies.{$i}" multiple="true" functional="true" groupname="$targetComps">-->
                  <find_object_component object="$enemies.{$i}" multiple="true" invulnerable="false" integrated="false" indestructible="false" checkoperational="true" groupname="$targetComps">
                    <match_size min="100m"/>
                  </find_object_component>
                  <do_if value="$targetComps.list.count and $thiscombinedskill lt 80">
                    <add_to_group groupname="$targets" list="$targetComps.list"/>
                  </do_if>
                  <do_else>
                    <do_all exact="$targetComps.list.count" counter="$j">
                      <do_if value="$targetComps.list.{$j}? and not $targetComps.list.{$j}.iswreck">
                        <continue />
                      </do_if>
                      <!--subcomps found, add each to pri list IHC/torpedoes + general targets list-->
                      <add_to_group groupname="$targets" object="$targetComps.list.{$j}"/>
                      <do_if value="$targetComps.list.{$j}.isclass.[class.destructible, class.production, class.buildmodule, class.storage, class.radar] and $targetComps.list.{$j}.size ge 400m">
                        <add_to_group groupname="$validbigguntarget" object="$targetComps.list.{$j}"/>
                      </do_if>
                      <!--set_value name="$result" exact="false"/>
                      <check_line_of_sight name="$result" object="this.ship" target="$targetComps.list.{$j}" chance="if not $targetIsStation and $thiscombinedskill ge 80 then 100 else 0"/>
                      <add_to_group groupname="$targetsInSight" object="$targetComps.list.{$j}" chance="if $result then 100 else 0"/-->
                      <wait exact="player.timewarp.factor/100" sinceversion="2" chance="player.timewarp.active*100" />
                    </do_all>
                  </do_else>
                </do_if>
                <do_elseif value="@this.$config_attackenemies == 1 and not $boardingFlag">
                  <add_to_group groupname="$targets" list="$tmpWeapons" />
                  <add_to_group groupname="$validbigguntarget" object="$enemies.{$i}" />
                </do_elseif>
                <do_elseif value="$boardingFlag">
                  <add_to_group groupname="$targets" list="$tmpWeapons" />
                </do_elseif>
                <do_elseif value="not @this.$config_attackenemies and $enemies.{$i} == $target">
                  <add_to_group groupname="$targets" object="$enemies.{$i}" />
                  <add_to_group groupname="$validbigguntarget" object="$enemies.{$i}" />
                </do_elseif>
                <do_elseif value="not $target.isoperational and $validbigguntarget.count == 0">
                  <add_to_group groupname="$targets" object="$enemies.{$i}" />
                  <add_to_group groupname="$targets" list="$tmpWeapons" />
                </do_elseif>
                <do_else>
                  <add_to_group groupname="$targets" object="$enemies.{$i}" />
                </do_else>
                <remove_value name="$targetComps" />
                <remove_value name="$result" />
                <remove_value name="$boardingFlag" />
                <remove_value name="$tmpWeapons" />
              </do_elseif>
              <do_else>
                <!-- Add to general target list if .isclass other -->
                <add_to_group groupname="$targets" object="$enemies.{$i}" />
              </do_else>
            </do_if>
            <do_else comment="not so 1337 Version">
              <do_if value="$enemies.{$i}.isclass.[class.ship_xs, class.ship_s, class.ship_m]">
                <add_to_group groupname="$targets" object="$enemies.{$i}" chance="[90-$i, 50].max" />
                <add_to_group groupname="$dronetargets" object="$enemies.{$i}" chance="70"/>
              </do_if>
              <do_elseif value="$enemies.{$i}.isclass.[class.ship_xl, class.ship_l]">
                <add_to_group groupname="$targets" object="$enemies.{$i}" chance="100" />
                <add_to_group groupname="$validbigguntarget" object="$enemies.{$i}" chance="88"/>
                <create_group groupname="$targetComps" />
                <find_object_component object="$enemies.{$i}" groupname="$targetComps" class="[class.engine, class.launcher]" surfaceelement="true" invulnerable="false" checkoperational="true" multiple="true" integrated="false" chance="if $thiscombinedskill lt 40 then 50 else 0"/>
                <find_object_component object="$enemies.{$i}" groupname="$targetComps" class="[class.engine, class.turret, class.jumpdrive, class.weapon, class.launcher]" surfaceelement="true" invulnerable="false" checkoperational="true" multiple="true" integrated="false" chance="if $enemies.{$i}.boarder and @this.ship.relationto.{$enemies.{$i}.boarder} ge 0 then 80 else if $thiscombinedskill ge 40 then 50 else 0"/>
                <add_to_group groupname="$dronetargets" list="$targetComps.list" chance="75"/>
                <do_if value="$targetComps.list.count and this.ship.distanceto.{$enemies.{$i}} le $FiringRange/2">
                  <add_to_group groupname="$targets" list="$targetComps.list"/>
                </do_if>
                <remove_value name="$targetComps" />
              </do_elseif>
              <do_elseif value="$enemies.{$i}.isclass.station">
                <do_if value="$LRShip">
                  <find_ship name="$TroopShip" functional="true" space="$enemies.{$i}.zone" multiple="false" chance="if $TroopShip? then 0 else 100">
                    <match_any>
                      <match macro="macro.units_size_l_troop_transporter1_macro"/>
                      <match macro="macro.units_size_l_troop_transporter5_macro"/>
                      <match macro="macro.units_size_m_boarding_macro"/>
                    </match_any>
                    <match_relation faction="this.ship.owner" relation="neutral" comparison="ge" />
                  </find_ship>

                  <find_object_component object="$enemies.{$i}" groupname="$targetComps" invulnerable="false" integrated="false" checkoperational="true"  multiple="true" chance="if $TroopShip then 0 else 100" />
                  <find_object_component object="$enemies.{$i}" groupname="$targetComps" class="[class.turret, class.weapon, class.launcher]" surfaceelement="true" invulnerable="false" checkoperational="true" multiple="true" integrated="false" chance="if $TroopShip then 100 else 0"/>
                  <do_if value="$targetComps.list.count">
                    <add_to_group groupname="$targets" list="$targetComps.list"/>
                    <add_to_group groupname="$validbigguntarget"  list="$targetComps.list" chance="if $TroopShip then 0 else 100"/>
                  </do_if>
                  <remove_value name="$targetComps" />
                </do_if>
                <do_else>
                  <add_to_group groupname="$targets" object="$enemies.{$i}" chance="40" />
                </do_else>
              </do_elseif>
              <do_else>
                <add_to_group groupname="$targets" object="$enemies.{$i}" chance="50" />
              </do_else>
              <!-- fallback -->
              <do_if value="$enemies.{$i} == $target and $targets.list.indexof.{$enemies.{$i}} == 0">
                <add_to_group groupname="$targets" object="$enemies.{$i}" />
              </do_if>
            </do_else>
          </do_if>
          <wait exact="player.timewarp.factor/3" sinceversion="2" />
        </do_all>
        <remove_value name="$TroopShip" />
        <remove_value name="$closestTarget" />

        <!-- Turret/weapon target and fire logic-->
        <do_if value="$targets.count">

          <set_value name="$MainTarget" exact="$target" />
          <set_value name="$boardingFlag" exact="if @$target and @$target.isclass.defensible and @$target.boarder and @this.ship.relationto.{$target.boarder} ge 0 and $target.hullpercentage le 70 then true else false"/>

          <do_if value="$target and $target.isclass.station and not $boardingFlag">
            <set_value name="$targetsInSight_chance" exact="if $targetsInSight.count then 100 else 0"/>
            <find_object_component object="$target" groupname="$targetComps" multiple="true" invulnerable="false" integrated="false" surfaceelement="false" checkoperational="true" indestructible="false"/>
            <do_all exact="$targetComps.list.count" counter="$j">
              <do_if value="$targetComps.list.{$j}? and $targetComps.list.{$j}.hullpercentage gt -1 and not $targetComps.list.{$j}.iswreck">
                <do_if value="$targetComps.list.{$j}.isclass.[class.destructible, class.production, class.buildmodule, class.storage, class.radar] and $targetComps.list.{$j}.size ge 400m">
                  <add_to_group groupname="$validbigguntarget" object="$targetComps.list.{$j}"/>
                  <add_to_group groupname="$targetsInSight" object="$targetComps.list.{$j}" chance="$targetsInSight_chance"/>
                  <add_to_group groupname="$targets" object="$targetComps.list.{$j}"/>
                </do_if>
                <do_else>
                  <add_to_group groupname="$targets" object="$targetComps.list.{$j}"/>
                </do_else>
                <set_value name="$tmp_dist" exact="this.ship.distanceto.{$targetComps.list.{$j}}" />
                <check_line_of_sight name="$result" object="this.ship" target="$targetComps.list.{$j}"/>
                <do_if value="$result and $tmp_dist le $FiringRange">
                  <set_value name="$tmp_MainTarget" exact="$targetComps.list.{$j}" />
                  <break />
                </do_if>
                <do_elseif value="$result and not $tmp_MainTarget_dist? or $tmp_dist le @$tmp_MainTarget_dist">
                  <set_value name="$tmp_MainTarget" exact="$targetComps.list.{$j}" />
                  <set_value name="$tmp_MainTarget_dist" exact="$tmp_dist" />
                </do_elseif>
                <do_elseif value="not $result and not $tmp_MainTarget_dist?">
                  <set_value name="$tmp_MainTarget" exact="$targetComps.list.{$j}" />
                  <set_value name="$tmp_MainTarget_dist" exact="$tmp_dist" />
                </do_elseif>
              </do_if>
            </do_all>
            <do_if value="$tmp_MainTarget?">
              <set_value name="$MainTarget" exact="$tmp_MainTarget" />
            </do_if>
            <remove_value name="$tmp_dist" />
            <remove_value name="$tmp_MainTarget_dist" />
            <remove_value name="$tmp_MainTarget" />
            <remove_value name="$targetComps" />
            <remove_value name="$result" />
            <remove_value name="$targetsInSight_chance" />
          </do_if>
          <do_if value="$MainTarget.exists and not $MainTarget.iswreck" negate="true">
            <do_if value="$targetsInSight.count and $validbigguntarget.count">
              <do_all exact="$validbigguntarget.list.count" counter="$j">
                <do_if value="$targetsInSight.list.indexof.{$validbigguntarget.list.{$j}}">
                  <set_value name="$MainTarget" exact="$validbigguntarget.list.{$j}" />
                  <break />
                </do_if>
              </do_all>
            </do_if>
            <do_elseif value="$validbigguntarget.count">
              <set_value name="$MainTarget" exact="$validbigguntarget.list.random"/>
            </do_elseif>
          </do_if>
          <!-- primary_slot-->
          <do_if value="not $boardingFlag and $validbigguntarget.count and $target.isoperational">
            <shoot_at object="this.ship" slot="tag.primary_slot" tolerance="10.0deg" target="if $MainTarget.exists and not $MainTarget.iswreck then $MainTarget else $target" weapontype="combat" /> <!-- additional_targets="$validbigguntarget.list" -->
            <do_if value="$LRShip">
              <set_value name="this.ship.pilot.$priotarget" exact="$MainTarget"/>
            </do_if>
          </do_if>
          <do_elseif value="$MainTarget and not $boardingFlag and $validbigguntarget.count and not $MainTarget.isclass.[class.ship_xs, class.ship_s, class.ship_m]">
            <set_value name="this.ship.pilot.$priotarget" exact="$MainTarget"/>
            <shoot_at object="this.ship" slot="tag.primary_slot" tolerance="10.0deg" target="$MainTarget" weapontype="combat" /><!-- additional_targets="$validbigguntarget.list" -->
          </do_elseif>
          <do_else>
            <stop_shooting object="this.ship" slot="tag.primary_slot"/>
            <do_if value="this.ship.pilot.$priotarget?">
              <remove_value name="this.ship.pilot.$priotarget" />
            </do_if>
          </do_else>
          <!-- secondary_slot-->
          <set_value name="$tmpDeg" exact="120.0deg"/>
          <do_if value="$thiscombinedskill ge 80">
            <set_value name="$tmpDeg" exact="360.0deg"/>
          </do_if>
          <do_elseif value="$thiscombinedskill ge 50">
            <set_value name="$tmpDeg" exact="240.0deg"/>
          </do_elseif>

          <do_if value="$LRShip and not $boardingFlag" chance="if $target and $target.isclass.station then 100 else 0">
            <set_value name="this.ship.pilot.$priotarget" exact="$MainTarget"/>
            <shoot_at object="this.ship" slot="tag.secondary_slot" tolerance="$tmpDeg" target="$MainTarget" weapontype="combat" /><!-- additional_targets="if $validbigguntarget.list.count then $validbigguntarget.list else $targetsInSight.list" -->
          </do_if>
          <do_elseif value="$MainTarget.exists and not $boardingFlag">
            <do_if value="$LRShip" chance="if $MainTarget.isclass.[class.ship_xs, class.ship_s, class.ship_m] then 0 else 100">
              <shoot_at object="this.ship" slot="tag.secondary_slot" tolerance="$tmpDeg" target="$MainTarget" locktarget="true" weapontype="combat" />
            </do_if>
            <do_elseif value="$LRShip" negate="true">
              <shoot_at object="this.ship" slot="tag.secondary_slot" tolerance="$tmpDeg" target="$MainTarget" locktarget="true" weapontype="combat" /><!-- additional_targets="if $targetsInSight.list.count then $targetsInSight.list else $validbigguntarget.list" -->
            </do_elseif>
            <do_else>
              <stop_shooting object="this.ship" slot="tag.secondary_slot" chance="50"/>
            </do_else>
          </do_elseif>
          <do_elseif value="not $boardingFlag and $validbigguntarget.count and ($targetsInSight.indexof.{$validbigguntarget.{1}} or $thiscombinedskill le 70)">
            <shoot_at object="this.ship" target="$validbigguntarget.{1}" slot="tag.secondary_slot" tolerance="$tmpDeg" weapontype="combat" /><!-- additional_targets="$validbigguntarget.list" -->
          </do_elseif>
          <do_else>
            <stop_shooting object="this.ship" slot="tag.secondary_slot"/>
          </do_else>
          <remove_value name="$tmpDeg" />
          <!-- turrets -->
          <do_if value="$MainTarget and not $boardingFlag" chance="if $target and $target.isclass.station then 100 else 0">
            <set_turret_targets object="this.ship" preferredtarget="$MainTarget" target="if $validbigguntarget.list.count gt 5 then $validbigguntarget.list else $targets.list"  />
          </do_if>
          <do_elseif value="$MainTarget and $boardingFlag">
            <set_turret_targets object="this.ship" target="if $targetsInSight.list.count gt 5 then $targetsInSight.list else $targets.list" />
          </do_elseif>
          <do_else>
            <set_turret_targets object="this.ship" target="if $targetsInSight.list.count gt 10 then $targetsInSight.list else if $validbigguntarget.list.count gt 10 then $validbigguntarget.list else $targets.list" />
          </do_else>

          <!-- v0.19 test to make stations more destructible IZ -->
          <do_if value="not $boardingFlag and $MainTarget.hullpercentage ge 10 and this.ship.dps.all gt 80000f" chance="if $MainTarget and ($MainTarget.isclass.station or $MainTarget.container.isclass.station) then 100 else 0">
            <set_value name="$damage" min="2" max="5" chance="if $MainTarget.shieldpercentage gt 10 then 0 else 100"/>
            <set_value name="$damage" min="0" max="1" chance="if $MainTarget.shieldpercentage gt 10 then 100 else 0"/>
            <set_object_hull object="$MainTarget" exact="$MainTarget.hullpercentage - $damage" chance="44"/>
            <remove_value name="$damage" />
          </do_if>

          <!-- v0.19 test to make stations more destructible IZ-->

        </do_if>
        <do_else>
          <stop_shooting object="this.ship" slot="tag.primary_slot"/>
          <stop_shooting object="this.ship" slot="tag.secondary_slot"/>
          <!--<cease_fire object="this.ship" weapontype="combat"/>
            <!{1}** Simulate the stand by **{1}>
            <set_command_action commandaction="commandaction.standingby" />-->
          <do_if value="this.ship.pilot.$priotarget?">
            <remove_value name="this.ship.pilot.$priotarget" />
          </do_if>
        </do_else>
        <!-- Launch drones -->
        <do_if value="$dronetargets.count">
          <do_if value="true" chance="if $thiscombinedskill ge 90 then 100 else 30">
            <set_value name="this.$dronetargetsShare" exact="$dronetargets.list.count"/>
          </do_if>
          <do_else>
            <remove_value name="this.$dronetargetsShare" />
          </do_else>
          <do_if value="player.age" min="$lastdronelaunch + 90s" chance="if this.ship.isboostactive then 0 else 100">
            <set_value name="$lastdronelaunch" exact="player.age"/>
            <find_object_component groupname="$dronepads" object="this.ship" class="class.dronelaunchpad" multiple="true" checkoperational="true" />
            <do_all exact="[($thiscombinedskill/10)i,$dronepads.count].min" counter="$i">
              <launch_drone name="$drone" object="$dronepads.{$i}" exact="5" group="unitcategory.defence"/>
              <do_if value="$drone">
                <start_script object="$drone.pilot" name="'fight.attack.object.drone.leader'">
                  <param name="target" value="$dronetargets.random" />
                  <param name="additionaltargets" value="$dronetargets" />
                  <param name="checkrelation" value="$checkrelation" />
                </start_script>
              </do_if>
              <remove_value name="$drone"/>
            </do_all>
            <remove_value name="$dronepads"/>
          </do_if>
        </do_if>
        <do_else>
          <remove_value name="this.$dronetargetsShare" />
        </do_else>
        <remove_value name="$drone" />
        <remove_value name="$boardingFlag" />

        <signal_objects object="player.galaxy" param="'learned.something'" param2="[this, ware.inv_virtualseminarcombat, 'kill']" />

        <wait min="10s" max="20s" chance="0" />
        <clear_group group="$targetsInSight"/>
        <clear_group group="$validbigguntarget"/>
      </do_if>
      <do_else>
        <cease_fire object="this.ship" weapontype="combat"/>

        <!-- Simulate the stand by -->
        <set_command_action commandaction="commandaction.standingby" />

      </do_else>

      <label name="finish" />
      <!--added compatibility for patch 4.00-->
      <!-- wait until the next enemy check (this can be interrupted if new attacker attack) -->
      <wait exact="$nextenemycheck - player.age" />
      <!--added compatibility for patch 4.00-->

      <!-- Continue if the Config is Attack, or if there is still a PROVIDED target -->
      <do_if value="@this.$config_attackenemies or $target.isoperational">
        <clear_group group="$targets"/>
        <clear_group group="$dronetargets"/>
        <resume label="FindEnemies"/>
      </do_if>

      <cease_fire object="this.ship" weapontype="combat"/>

      <remove_value name="this.$missiles" />
      <remove_value name="this.$dronetargetsShare" />
      <do_if value="@this.ship.pilot.$priotarget">
        <remove_value name="this.ship.pilot.$priotarget" />
      </do_if>

    </actions>
  </attention>
  <attention min="unknown">
    <actions>

      <debug_text text="'Firing range for: ' + this.ship.knownname + ' is: ' + $FiringRange" chance="$debugoutputchance"/>

      <label name="FindEnemies" />
      <set_value name="$thiscombinedskill" exact="this.combinedskill"/>
      <!--set_value name="$doAttackenemies" exact="this.ship.owner == this.ship.trueowner and ((@this.$config_attackenemies == 1 and this.ship.isplayerowned) or not this.ship.isplayerowned)"/-->
      <set_value name="$doAttackenemies" exact="this.ship.owner == this.ship.trueowner and (@this.$config_attackenemies == 1  or (not this.ship.isplayerowned and not this.$config_attackenemies?))"/>
      <set_value name="$doAllowothertargets" exact="$doAttackenemies and $allowothertargets"/>
      <do_if value="$target.exists and not @$target.isclass.defensible and @$target.container.isclass.defensible">
        <set_value name="$target" exact="$target.container" />
      </do_if>

      <!-- ammo check -->
      <do_if value="player.age gt @$nextammocheck">
        <set_value name="$FiringRange" exact="this.ship.maxcombatrange.all * 1.2f + this.ship.size"/>
        <set_value name="$skillpower" exact="this.combinedskill"/>
        <set_value name="$skillpower" exact="this.ship.pilot.combinedskill" operation="add" chance="this.ship.pilot.exists*100"/>
        <set_value name="$skillpower" exact="this.ship.engineer.combinedskill" operation="add" chance="this.ship.engineer.exists*100"/>
        <set_value name="$skillpower" exact="if $skillpower gt 3 then $skillpower / 3 else $skillpower"/>
        <set_value name="$ammodelay" min="8min" max="12min" />
        <set_value name="$nextammocheck" exact="player.age + $ammodelay" />

        <run_script name="'lib.ammo.missiles'" result="$needammo">
          <save_retval name="macros" variable="$order_macrolist" />
          <save_retval name="amounts" variable="$order_amountlist" />
        </run_script>

        <do_if value="$needammo">
          <do_all exact="$order_macrolist.count" counter="$i">
            <add_ammo object="this.ship" macro="$order_macrolist.{$i}" amount="$order_amountlist.{$i}" />
          </do_all>
        </do_if>

        <remove_value name="$order_macrolist" />
        <remove_value name="$order_amountlist" />
      </do_if>

      <!-- Create/clean list of enemies -->
      <create_list name="$enemies" />

      <!-- Find (more) enemies if no target or other targets are allowed -->
      <do_if value="(not $target and $doAttackenemies) or @$doAllowothertargets">
        <find_gravidar_contact name="$enemies" object="this.ship" functional="true" maybeattackedby="this.ship" multiple="true">
          <match_distance object="this.ship" max="$FiringRange"/>
        </find_gravidar_contact>
      </do_if>

      <do_all exact="$attackers.count" counter="$i">
        <do_if value="not $enemies.indexof.{$attackers.{$i}} and this.ship.mayattack.{$attackers.{$i}}">
          <append_to_list name="$enemies" exact="$attackers.{$i}" />
        </do_if>
      </do_all>
      <clear_group group="$attackers"/>

      <do_if value="$target.isclass.station or @$doAllowothertargets">
        <find_gravidar_contact name="$Capital" object="this.ship" class="[class.ship_l, class.ship_xl]" functional="true" maybeattackedby="this.ship" multiple="false">
          <match_distance object="this.ship" max="$FiringRange"/>
          <match primarypurpose="objectpurpose.fight"/>
        </find_gravidar_contact>
        <find_gravidar_contact name="$Stations" object="this.ship"  class="class.station" functional="true" maybeattackedby="this.ship" multiple="true">
          <match_distance object="this.ship" max="$FiringRange"/>
          <match owner="faction.enemy" negate="true"/>
          <match owner="faction.criminal" negate="true"/>
          <match owner="faction.smuggler" negate="true"/>
          <match owner="faction.ownerless" negate="true"/>
          <match owner="faction.neutral" negate="true"/>
        </find_gravidar_contact>
        <do_all exact="$Stations.count" counter="$i">
          <do_if value="not $Capital and (not $attackint? or ($attackint? and $attackint lt player.age))" chance="0">
            <find_object_component object="$Stations.{$i}" multiple="true" class="class.destructible" checkoperational="true" invulnerable="false" functional="true" integrated="false" groupname="$targetComps">
              <match_size min="10m"/>
            </find_object_component>
            <do_all exact="$targetComps.list.count" counter="$j">
              <do_if value="$targetComps.list.{$j}.isoperational and $targetComps.list.{$j}.hullpercentage">
                <do_if value="not $enemies.indexof.{$targetComps.list.{$j}}">
                  <append_to_list name="$enemies" exact="$targetComps.list.{$j}" />
                </do_if>
              </do_if>
            </do_all>
          </do_if>
          <do_if value="not $enemies.indexof.{$Stations.{$i}}">
            <append_to_list name="$enemies" exact="$Stations.{$i}" />
          </do_if>
        </do_all>
        <do_if value="not $enemies.indexof.{$Capital}">
          <append_to_list name="$enemies" exact="$Capital" />
        </do_if>
      </do_if>
      <remove_value name="$Capital" />
      <remove_value name="$Stations" />
      <remove_value name="$targetComps" />
      <do_if value="$target.isoperational">
        <!--check if target is already in list of enemies-->
        <do_if value="not $enemies.indexof.{$target}">
          <do_if value="this.ship.mayattack.{$target} or not $checkrelation" comment="check relation of ship (not defense NPC)" >
            <debug_text text="'Prefered target of: ' + this.ship.knownname + ' is: ' + $target.knownname" chance="$debugoutputchance"/>
            <append_to_list name="$enemies" exact="$target" />
          </do_if>
        </do_if>
      </do_if>

      <!-- ok, we have found enemies, let's do something about them -->
      <set_value name="$attacktime" min="player.age + 30s" max="player.age + 40s" />
      <do_if value="player.timewarp.active">
        <set_value name="$attacktime" exact="player.timewarp.factor*10" operation="add" />
        <remove_value name="$noTW" />
      </do_if>
      <do_else>
        <set_value name="$noTW" />
      </do_else>
      <!-- Fight -->
      <do_if value="$enemies.count" min="1">
        <!-- Simulate the attack -->
        <set_command_action commandaction="commandaction.attacking" />

        <activate_battlestate object="this.ship" state="battlestate_red" />
      </do_if>
      <do_else>
        <!-- Simulate the stand by -->
        <set_command_action commandaction="commandaction.standingby" />
      </do_else>

      <set_value name="$targetIsStation" exact="if $target and $target.isclass.station then true else false" />

      <set_value name="$waittime" exact="player.timewarp.factor*5" />

      <clear_group group="$targets"/>
      <!-- For each enemy, apply strength-->
      <do_while value="$enemies.count" min="1">
        <debug_text text=" ' unknown. ' + this.ship + ' fight. enemies: ' + $enemies " chance="$debugoutputchance" />

        <do_if value="$target.isoperational" negate="true" chance="if @this.$config_attackenemies then 100 else 0">
          <set_value name="$temp" exact="null" />
          <do_all exact="$enemies.count" counter="$y" reverse="true">
            <do_if value="$enemies.{$y}.isclass.defensible and $enemies.{$y}.isoperational" negate="true">
              <remove_value name="$enemies.{$y}" />
              <continue />
            </do_if>
            <do_if value="$enemies.{$y}.isclass.[class.ship_l, class.ship_xl] and (not $temp or this.ship.distanceto.{$enemies.{$y}} lt this.ship.distanceto.{$temp})" chance="if $temp and $temp.isclass.station then 0 else 100">
              <set_value name="$temp" exact="$enemies.{$y}"/>
            </do_if>
            <do_elseif value="$enemies.{$y}.isclass.station and (not $temp or this.ship.distanceto.{$enemies.{$y}} lt this.ship.distanceto.{$temp}) and this.ship.distanceto.{$enemies.{$y}} lt $FiringRange">
              <set_value name="$temp" exact="$enemies.{$y}"/>
              <break />
            </do_elseif>
            <do_elseif value="$enemies.{$y}.isclass.[class.ship_s, class.ship_m] and (not $temp or this.ship.distanceto.{$enemies.{$y}} lt this.ship.distanceto.{$temp})" chance="if $temp and $temp.isclass.[class.ship_l, class.ship_xl, class.station] then 0 else 100">
              <set_value name="$temp" exact="$enemies.{$y}"/>
            </do_elseif>
          </do_all>
          <set_value name="$target" exact="$temp" />
        </do_if>

        <do_all exact="$enemies.count" counter="$i" reverse="true">
          <do_if value="not @$MaxEnemies">
            <!-- Search/Attacking waiting time -->
            <set_value name="$waittime" min="player.timewarp.factor" max="[player.timewarp.factor * 4, 60s].min" profile="increasing" />
            <wait exact="$waittime"/>

            <!--The maximum amount of enemies to be hit in this volley, based on the number of operational turrets-->
            <set_value name="$MaxEnemies" exact="[this.ship.summary.numturrets.operational / 5, 3, $enemies.count].min"/>
            <set_value name="$MaxEnemies" min="1" max="$MaxEnemies" profile="increasing"/>
          </do_if>

          <do_if value="$enemies.{$i}.isclass.defensible and $enemies.{$i}.isoperational">
            <do_if value="this.ship.distanceto.{$enemies.{$i}} gt ($FiringRange + $enemies.{$i}.size*0.5f)">
              <continue />
            </do_if>
            <do_if value="$enemies.{$i}.isclass.[class.ship, class.station]">
              <do_if value="$enemies.{$i}.boarder and @this.ship.relationto.{$enemies.{$i}.boarder} ge 0 and $enemies.{$i}.hullpercentage le 70 and this.ship.shieldpercentage ge 20" >
                <continue />
              </do_if>
              <do_elseif value="$targets.list.indexof.{$enemies.{$i}} == 0">
                <add_to_group groupname="$targets" object="$enemies.{$i}"/>
              </do_elseif>
            </do_if>
            <!-- exclude the player ship in OOS case, this scenario wouldn't make any sense anyway -->
            <do_if value="$enemies.{$i} != player.primaryship and ($enemies.{$i}.isclass.defensible or ($enemies.{$i}.container? and $enemies.{$i}.container.isclass.defensible))">
              <!-- Get and apply strengths-->
              <do_if value="true" chance="[this.combinedskill, 90].max" comment="chance of succeed">
                <!-- do not attack objects that are too far away, gravidar range can be 50km+ !! -->
                <do_if value="not $enemies.{$i}.iswreck and $enemies.{$i}.isclass.station">
                  <do_if value="$enemies.{$i}.hullpercentage">
                    <!-- find attackpart -->
                    <do_if value="$enemies.{$i}.boarder and this.ship.relationto.{$enemies.{$i}.boarder}">
                      <find_object_component object="$enemies.{$i}" name="$targetpart" class="[class.turret, class.weapon, class.launcher]" surfaceelement="true" multiple="false" checkoperational="true" invulnerable="false" integrated="false"/>
                    </do_if>
                    <do_else>
                      <find_object_component object="$enemies.{$i}" multiple="false" invulnerable="false" functional="true" integrated="false" name="$targetpart">
                        <match_size min="800m"/>
                      </find_object_component>
                      <do_if value="@$targetpart" negate="true">
                        <find_object_component object="$enemies.{$i}" multiple="false" invulnerable="false" integrated="false" surfaceelement="false" checkoperational="true" indestructible="false" name="$targetpart">
                          <match_size min="400m"/>
                        </find_object_component>
                      </do_if>
                    </do_else>
                    <do_if value="$targetpart" negate="true">
                      <set_value name="$targetpart" exact="$enemies.{$i}"/>
                    </do_if>
                    <do_if value="not @this.ship.mayattack.{$enemies.{$i}}" >
                      <add_relation_boost object="this.ship" otherobject="$enemies.{$i}" value="$enemies.{$i}.trueowner.relation.kill.max" decay="1" delay="10min" silent="true" />
                    </do_if>
                    <get_attackstrength object="this.ship" target="$enemies.{$i}" usedrones="$targetpart.isclass.station" result="$result" />
                    <set_value name="$damageAll" exact="($result * ($waittime)f)hp"/>
                    <!-- simulate damage -->
                    <do_if value="$enemies.{$i}.shieldpercentage and $damageAll gt 0">
                      <set_value name="$defValue" exact="$enemies.{$i}.shield"/>
                      <set_value name="$defValueM" exact="$enemies.{$i}.maxshield"/>
                      <set_value name="$attackValue" min="$damageAll*0.2f" max="$damageAll"/>
                      <set_value name="$attackValue" exact="[$attackValue, $defValue].min"/>
                      <set_value name="$damageAll" exact="$attackValue" operation="subtract"/>
                      <set_value name="$newValue" exact="([$defValue-$attackValue,0hp].max / $defValueM)*100"/>
                      <set_object_shield object="$enemies.{$i}" exact="$newValue" />
                      <remove_value name="$newValue" />
                      <remove_value name="$attackValue" />
                      <remove_value name="$defValueM" />
                      <remove_value name="$defValue" />
                    </do_if>
                    <do_if value="$targetpart.shieldpercentage and $damageAll gt 0">
                      <set_value name="$defValue" exact="$targetpart.shield"/>
                      <set_value name="$defValueM" exact="$targetpart.maxshield"/>
                      <set_value name="$attackValue" min="$damageAll*0.2f" max="$damageAll"/>
                      <set_value name="$attackValue" exact="[$attackValue, $defValue].min"/>
                      <set_value name="$damageAll" exact="[$attackValue, $defValue].min" operation="subtract"/>
                      <set_value name="$newValue" exact="([$defValue-$attackValue,0hp].max / $defValueM)*100"/>
                      <set_object_shield object="$targetpart" exact="$newValue" />
                      <remove_value name="$newValue" />
                      <remove_value name="$attackValue" />
                      <remove_value name="$defValueM" />
                      <remove_value name="$defValue" />
                    </do_if>
                    <do_if value="$damageAll gt 0">
                      <set_value name="$defValue" exact="$targetpart.hull"/>
                      <set_value name="$defValueM" exact="$targetpart.maxhull"/>
                      <set_value name="$attackValue" min="$damageAll*0.2f" max="$damageAll" profile="increasing"/>
                      <set_value name="$attackValue" exact="[$attackValue, $defValue].min"/>
                      <set_value name="$damageAll" exact="$attackValue" operation="subtract"/>
                      <set_value name="$newValue" exact="([$defValue-$attackValue,0hp].max / $defValueM)*100"/>
                      <do_if value="$newValue ge 1" negate="true">
                        <destroy_object object="$targetpart" explosion="true"/>
                      </do_if>
                      <do_else>
                        <set_object_hull object="$targetpart" exact="$newValue" />
                      </do_else>
                      <remove_value name="$newValue" />
                      <remove_value name="$attackValue" />
                      <remove_value name="$defValueM" />
                      <remove_value name="$defValue" />
                    </do_if>
                    <!-- trigger attack, damage do not work for real at stations it seems like -->
                    <apply_attackstrength object="$enemies.{$i}" attacker="this.ship" strength="if $damageAll gt 0 then ($damageAll)f else 1000f" result="$isdead" chance="if $result gt 0 then 100 else 0" />
                    <remove_value name="$damageAll" />
                    <remove_value name="$targetpart" />
                    <remove_value name="$result" />
                  </do_if>
                </do_if>
                <do_else>
                  <!-- Get the strength in 'result'-->
                  <set_value name="$usedrones" exact="false"/>
                  <do_if value="$enemies.{$i}.isclass.[class.ship_xs, class.ship_s, class.ship_m]">
                    <set_value name="$usedrones" exact="true"/>
                  </do_if>
                  <do_elseif value="$enemies.{$i}.isclass.[class.ship_l, class.ship_xl, class.station]" chance="@$skillpower">
                    <set_value name="$usedrones" exact="true"/>
                  </do_elseif>
                  <get_attackstrength object="this.ship" target="$enemies.{$i}" usedrones="$usedrones" result="$result" />
                  <!-- Apply the strength to target -->
                  <apply_attackstrength object="$enemies.{$i}" attacker="this.ship" strength="$result * ($waittime)f" result="$isdead" />
                  <debug_text text="'%1 OOS. Apply strength of %2 against %3 is: %4(%5|%6). Is killed: %7'.[player.age,this.ship.knownname,$enemies.{$i}.knownname,$result * ($waittime)f,$enemies.{$i}.hull,$enemies.{$i}.shield,$isdead]" chance="$debugoutputchance" />
                  <!--Wait so that attack/killed events are processed-->
                </do_else>
                <wait exact="player.timewarp.factor/30"/>
              </do_if>
              <do_else>
                <debug_text text="'%1 OOS. Apply attack fail of %2 against %3'.[player.age,this.ship.knownname,$enemies.{$i}.knownname]" chance="$debugoutputchance" />
              </do_else>
            </do_if>
          </do_if>
          <do_else>
            <remove_value name="$enemies.{$i}" />
          </do_else>

          <do_if value="$MaxEnemies gt 0">
            <set_value name="$MaxEnemies" operation="subtract"/>
          </do_if>
        </do_all>
        <wait exact="player.timewarp.factor/5" sinceversion="2" />
        <!-- Avoid an infite loop-->
        <do_if value="player.timewarp.active and $noTW?">
          <set_value name="$attacktime" exact="player.timewarp.factor*10" operation="add" />
          <remove_value name="$noTW" />
        </do_if>
        <do_if value="player.age" min="$attacktime">
          <break/>
        </do_if>
      </do_while>

      <signal_objects object="player.galaxy" param="'learned.something'" param2="[this, ware.inv_virtualseminarcombat, 'kill']" />


      <label name="finish" />
      <!-- Continue if the Config is Attack  or if there is still a target -->
      <do_if value="@this.$config_attackenemies or $target.isoperational">
        <wait min="5s" max="[player.timewarp.factor * 10, 60s].min" />
        <resume label="FindEnemies"/>
      </do_if>

      <cease_fire object="this.ship" weapontype="combat"/>

      <remove_value name="this.$missiles" />
      <remove_value name="this.$dronetargetsShare" />
      <do_if value="@this.ship.pilot.$priotarget">
        <remove_value name="this.ship.pilot.$priotarget" />
      </do_if>

    </actions>
  </attention>
  <on_abort>
    <remove_value name="this.$missiles" />
    <remove_value name="this.$dronetargetsShare" />
    <do_if value="@this.ship.pilot.$priotarget">
      <remove_value name="this.ship.pilot.$priotarget" />
    </do_if>
  </on_abort>
</aiscript>