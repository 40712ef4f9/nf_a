<?xml version="1.0" encoding="utf-8"?>

<mdscript name="MM_Care" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
	<cues>

		<cue name="SectionHandler_MM_Care_pilot" instantiate="true" >
			<conditions>
				<check_any>
					<event_conversation_next_section section="mmadvcom_main" />
					<event_conversation_returned_to_section section="mmadvcom_main" />
					<event_conversation_next_section sectionprefix="mmcare_do" />
				</check_any>
				<check_value value="event.object.trueowner" exact="faction.player" />
				<check_any>
					<check_value value="event.object.type" exact="entitytype.pilot" />
					<check_value value="event.object.type" exact="entitytype.commander" />
				</check_any>
				<check_value value="event.object.iscontrolentity" />
				<check_value value="event.object.ship.primarypurpose" exact="objectpurpose.fight" negate="true" />
				<check_value value="event.object.container.units.{unitcategory.welder}.count" />
			</conditions>
			<actions>
				<do_if value="event.param" exact="'mmcare_do_restore'">
					<find_gravidar_contact name="$RestoreTargets" object="event.object.container" restorable="true" multiple="true">
						<match_distance object="event.object.container" max="event.object.container.maxradarrange"/>
						<match_size min="300m"/>
					</find_gravidar_contact>
					<do_if value="$RestoreTargets.count">
						<set_value name="$todo_options_start" exact="event.param2" />
						<set_value name="$todo_options_max" exact="$RestoreTargets.count" />

						<do_if value="md.$mmcareWrecks?" negate="true">
							<create_list name="md.$mmcareWrecks"/>
						</do_if>
						<do_else>
							<do_all exact="md.$mmcareWrecks.count" counter="$Counter" reverse="true">
								<do_if value="not md.$mmcareWrecks.{$Counter}.exists">
									<remove_value name="md.$mmcareWrecks.{$Counter}" />
								</do_if>
							</do_all>
						</do_else>

						<do_all exact="6" counter="$i">
							<do_if value="$i == 6 and ($todo_options_start + 1) le $todo_options_max">
								<add_player_choice_sub 		text="{2802,1300}.[$todo_options_start, $todo_options_max]" 	position="bottom_right" section="mmcare_do_restore" 		choiceparam="$todo_options_start"/>
							</do_if>
							<do_elseif value="$todo_options_start le $todo_options_max">
								<add_player_choice		text="$RestoreTargets.{$todo_options_start}.macro.name" tooltip="{2802,1330}.[$RestoreTargets.{$todo_options_start}.distanceto.{event.object.container}]" 	position="$i" 	 selectable="md.$mmcareWrecks.indexof.{$RestoreTargets.{$todo_options_start}} == 0"	section="mmcare_do_restore_do" choiceparam="$RestoreTargets.{$todo_options_start}"/>
								<set_value name="$todo_options_start"  operation="add" exact="1" /> 
							</do_elseif>
							<do_elseif value="$i == 6">
								<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back"/>
							</do_elseif>
						</do_all>
					</do_if>
					<do_else>
						<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back" />
					</do_else>
					<remove_value name="$RestoreTargets"/>
					<remove_value name="$todo_options_start"/>
					<remove_value name="$todo_options_max"/>
				</do_if>
				<do_elseif value="event.param" exact="'mmcare_do_restore_do'">
					<create_group groupname="$docks" />
					<do_if value="global.$mmcarriers_xl? and event.object.container.macro.ismacro.{global.$mmcarriers_xl}">
						<do_all exact="2" counter="$j">
							<find_dock_location container="event.object.container" size="[tag.dock_xl, tag.dock_l].{$j}" name="$dock" multiple="true"/>
							<do_all exact="$dock.count" counter="$i">
								<do_if value="$docks.indexof.{$dock.{$i}.component} == 0 and not ($dock.{$i}.component.external and $dock.{$i}.component.docked.count)">
									<add_to_group groupname="$docks" object="$dock.{$i}.component" />
								</do_if>
								<do_else>
									<continue />
								</do_else>
							</do_all>
							<remove_value name="$dock"/>
						</do_all>
						<add_player_choice text="{2802,8200}" position="top_left" section="mmca_salvage_restore" choiceparam="[null, null, event.param2, true, 'engineer.ai.plus2']" comment="Dock Ships" />
						<add_player_choice text="{2802,8202}" position="left" section="mmca_salvage_restore" choiceparam="[null, null, event.param2, false, 'engineer.ai.plus2']" comment="Dock Ships" selectable="$docks.count" />
						<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back" />

						<remove_value name="$docks"/>
					</do_if>
					<do_else>
						<set_value name="$oldShip" exact="event.param2"/>
						<set_value name="$theShip" exact="event.object.container"/>
	
						<include_actions ref="md.MM_Care.MM_Care_restore_do" />

						<do_if value="$Ship? and $Ship.exists and $Ship.isclass.ship">
							<remove_from_player_squad object="$theShip" />
							<do_if value="$Ship.isclass.[class.ship, class.station]">
								<start_script name="'move.patrol.care'" object="$theShip.pilot">
									<param name="patrolobject" value="$Ship" />
								</start_script>
							</do_if>
						</do_if>
						<do_else>
							<!-- nothing -->
						</do_else>
						<remove_value name="$Ship" />
						<remove_value name="$theShip" />
					</do_else>

				</do_elseif>
				<!--do_elseif value="event.param" exact="'mmcare_do_restore_do_old'">

					<set_value name="$oldShip" exact="event.param2"/>
					<set_value name="$theShip" exact="event.object.container"/>

					<include_actions ref="md.MM_Care.MM_Care_restore_do" />

					<do_if value="$theShip.isclass.ship and event.param2.exists">
						<remove_from_player_squad object="$theShip" />
						<do_if value="$theShip.isclass.[class.ship, class.station]">
							<start_script name="'move.patrol.care'" object="$theShip.pilot">
								<param name="patrolobject" value="if $Ship? and $Ship.exists then $Ship else event.param2" />
							</start_script>
						</do_if>
						<do_else>
							<start_script name="'move.patrol.care'" object="$theShip.pilot">
								<param name="range" value="'zone'" />
								<param name="patrolobject" value="event.param2.zone" />
							</start_script>
						</do_else>
					</do_if>
					<do_if value="$Ship? and global.$mmcarriers_xl? and $theShip.macro.ismacro.{global.$mmcarriers_xl}">
						<create_group groupname="$docks" />
						<do_all exact="2" counter="$j">
							<find_dock_location container="$theShip" size="[tag.dock_xl, tag.dock_l].{$j}" name="$dock" multiple="true"/>
							<do_all exact="$dock.count" counter="$i">
								<do_if value="$docks.indexof.{$dock.{$i}.component} == 0 and not ($dock.{$i}.component.external and $dock.{$i}.component.docked.count)">
									<add_to_group groupname="$docks" object="$dock.{$i}.component" />
								</do_if>
								<do_else>
									<continue />
								</do_else>
							</do_all>
							<remove_value name="$dock"/>
						</do_all>
						<add_player_choice text="{2802,8200}" position="top_left" section="mmca_salvage" choiceparam="[null, null, $Ship]" comment="Dock Ships" selectable="$docks.count" />
						<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back" />
					</do_if>
					<remove_value name="$Ship" />
					<remove_value name="$theShip" />
				</do_elseif-->
				<do_elseif value="['mmcare_do_care', 'mmcare_do_pos', 'mmcare_do_pos_plus'].indexof.{event.param} and event.object.ship.primarypurpose == objectpurpose.build and @event.object.ship.buildanchor">
					<do_if value="event.object.container.engineer.exists and (not event.object.container.engineer.$Defensible? or not event.object.container.engineer.$doSupport?)">
						<set_value name="event.object.container.engineer.$doSupport" />
						<start_script object="event.object.container.engineer" name="'engineer.ai.plus2'"/>
					</do_if>
					<do_elseif value="event.object.container.engineer.exists">
						<start_script object="event.object.container.engineer" name="'engineer.ai.plus2'"/>
					</do_elseif>
				</do_elseif>
				<do_elseif value="event.param" list="['mmcare_do_pos', 'mmcare_do_pos_plus']">
					<remove_from_player_squad object="event.object.container" />
					<remove_object_commander object="event.object.container"/>
					<start_script name="'move.patrol.care'" object="event.object.container.pilot">
						<param name="range" value="if event.param2.{3}.isclass.zone then 'zone' else if event.param2.{3}.isclass.cluster then 'cluster' else 'sector'" />
						<param name="patrolobject" value="event.param2.{3}" />
						<param name="position" value="if event.param2.{4}? then position.[event.param2.{4}.{1}, event.param2.{4}.{2}, event.param2.{4}.{3}] else null" />
						<param name="ownstations" value="if event.param == 'mmcare_do_pos_plus' then true else false" />
					</start_script>
				</do_elseif>
				<do_elseif value="event.param" exact="'mmcare_do_care'">
					<do_if value="event.object.container.isclass.[class.ship_l, class.ship_xl]">
						<find_gravidar_contact name="$RestoreTargets" object="event.object.container" restorable="true" multiple="true">
							<match_distance object="event.object.container" max="event.object.container.maxradarrange"/>
							<match_size min="300m"/>
						</find_gravidar_contact>
						<add_player_choice text="{2802,1305}" position="top_right" section="mmcare_do_restore" selectable="$RestoreTargets.count gt 0" choiceparam="1" />
						<remove_value name="$RestoreTargets"/>
					</do_if>
					<add_player_choice text="{2802,1310}" section="gOrders_advancedflytopos" tooltip="{2802,1311}" comment="Fly to position" choiceparam="[0, 0, 'cluster', player.primaryship.cluster, null, null, 'selectposition', ['mmcare_do_pos']]"/>
					<add_player_choice text="{2802,1315}" section="gOrders_advancedflytopos" tooltip="{2802,1316}" comment="Fly to position" choiceparam="[0, 0, 'cluster', player.primaryship.cluster, null, null, 'selectposition', ['mmcare_do_pos_plus']]"/>
				</do_elseif>
				<do_else>
					<do_if value="event.object.ship.primarypurpose == objectpurpose.build and @event.object.ship.buildanchor">
						<add_player_choice_sub text="{2802,1301}" section="mmcare_do_care" choiceparam="1" immediate="event.object.container.engineer.$Defensible?" selectable="event.object.container.engineer.exists" />
					</do_if>
					<do_else>
						<add_player_choice_sub text="{2802,1301}" section="mmcare_do_care" choiceparam="1"  />
					</do_else>
				</do_else>
			</actions>
		</cue>
		<cue name="MM_Care_CheckCarriers" instantiate="true">
			<conditions>
			  <check_any>
				  <event_cue_signalled cue="md.Setup.GameStart"/>
				  <event_game_loaded/>
				  <event_player_created />
			  </check_any>
			</conditions>
			<delay max="6s"/>
			<actions>
				<set_value name="global.$mmcare_mmcarrier_is_active" exact="false"/>
				<do_if value="@md.$mmcarrierversion" min="142">
					<do_if value="md.$mmcarrier_on ge player.age - 10s">
						<set_value name="global.$mmcare_mmcarrier_is_active" exact="true"/>
					</do_if>
				</do_if>
			</actions>
		</cue>
		<cue name="MM_Care_AdvCom_work" instantiate="true">
			<conditions>
				<check_any>
					<event_conversation_next_section sectionprefix="mmadvcom_"/>
					<event_conversation_returned_to_section sectionprefix="mmadvcom_" />
				</check_any>
				<check_value value="md.$mm_advcom" exact="'care'" />
			</conditions>
			<actions>

				<do_if value="event.param == 'mmadvcom_main'">
					<add_player_choice 		text="{1002,12025}" 	position="bottom_right" section="mmadvcom_next" />
				</do_if>
				<do_elseif value="event.param == 'mmadvcom_next'">
					<!--add_player_choice 		text="{1002,12025}" 	position="bottom_right" section="mmadvcom_last" />
				</do_elseif>
				<do_elseif value="event.param == 'mmadvcom_last'"-->
					<add_player_choice_sub text="{1002,1051}" tooltip="{1026, 20006}" section="gMain_object" position="right" choiceparam="[0, 0, event.object.ship]" comment="Show Ship Details" />
					<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back" />
				</do_elseif>

			</actions>
		</cue>	
		<cue name="MM_Care_AdvCom_init" instantiate="true">
			<conditions>
			  <check_any>
				  <event_cue_signalled cue="md.Setup.GameStart"/>
				  <event_game_loaded/>
				  <event_player_created />
			  </check_any>
			</conditions>
			<delay max="500ms"/>
			<actions>
				<set_value name="md.$mm_advcom" exact="'care'"/>
			</actions>
		</cue>
		<!--
			<signal_objects object="player.galaxy" param="'learned.something'" param2="[this, ware.inv_virtualseminarnavigation]" />
		-->
		<cue name="MM_Care_restore" instantiate="true" namespace="this">
			<conditions>
				<event_object_signalled object="player.computer" param="'Care.DO.restore'" />
				<check_value value="event.param2? and event.param2.{2}? and event.param2.{1}.exists and event.param2.{1}.iswreck" />
			</conditions>
			<delay min="3s" max="8s"/>
			<actions>
				<set_value name="$oldShip" exact="event.param2.{1}"/>
				<set_value name="$theShip" exact="event.param2.{2}"/>
				<set_value name="$doCollect" exact="if event.param2.{3}? and event.param2.{3} then true else false"/>
				<include_actions ref="md.MM_Care.MM_Care_restore_do" />

				<do_if value="$Ship? and $Ship.exists and $Ship.isclass.ship and $doCollect">
					<find_dock_location container="event.object.container" size="$Ship.docksize" name="$dock" />
					<signal_objects object="$theShip" param="'collect ship'" param2="$Ship" param3="$dock" delay="10s"/>
					<remove_value name="$dock" />
				</do_if>
				<do_elseif value="$Ship? and $Ship.exists and $Ship.isclass.ship and not $doCollect">
					<remove_from_player_squad object="$theShip" />
					<do_if value="$Ship.isclass.[class.ship, class.station]">
						<start_script name="'move.patrol.care'" object="$theShip.pilot">
							<param name="patrolobject" value="$Ship" />
						</start_script>
					</do_if>
				</do_elseif>
				<do_else>
					<signal_objects object="$theShip" param="'stop order'" delay="3s"/>
				</do_else>

				<do_if value="$Ship? and $Ship.exists and $Ship.isclass.ship and $theShip.engineer.exists">
					<signal_objects object="$theShip" param="'engineer.support.this'" param2="$Ship" delay="20s"/>
				</do_if>

				<remove_value name="$doCollect" />
				<remove_value name="$theShip" />
				<remove_value name="$Ship" />
			</actions>
		</cue>

		<cue name="MM_Care_EngineerControl" instantiate="true">
			<conditions>
				<check_any>
					<event_conversation_started conversation="default" />
					<event_conversation_returned_to_section section="default" />
					<event_conversation_next_section sectionprefix="mmcareEC_do"/>
				</check_any>
				<check_value value="event.object.type" exact="entitytype.engineer" />
				<check_value value="event.object.iscontrolentity" />
				<check_value value="event.object.trueowner" exact="faction.player" />
			</conditions>
			<actions>
				<set_value name="$theObject" exact="event.object.container"/>
				<set_value name="$menue"/>
				<do_if value="event.param" exact="'mmcareEC_do_work'">
					<set_value name="$listComp" exact="event.param2"/>
					<do_if value="event.object.$work? and event.object.$work.$object == $listComp" negate="true">
						<signal_objects object="$theObject" param="'engineer.support.this'" param2="$listComp" />
					</do_if>
					<remove_value name="$menue" />
				</do_if>
				<do_elseif value="event.param" exact="'mmcareEC_do_element'">
					<signal_objects object="$theObject" param="'engineer.repair.this'" param2="event.param2" delay="2s"/>
					<remove_value name="$menue" />
				</do_elseif>
				<do_elseif value="event.param" exact="'mmcareEC_do_element_remove'">
					<signal_objects object="$theObject" param="'engineer.destruct.this'" param2="event.param2" delay="2s"/>
					<remove_value name="$menue" />
				</do_elseif>

				<do_if value="event.param" exact="'mmcareEC_do_remove'">
					<remove_value name="$menue" />
					<set_value name="$ABC" exact="['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z']"/>
					<set_value name="$RemoveTargets" exact="if typeof event.param2 == datatype.list and event.param2.{2}? and typeof event.param2.{2} == datatype.list then event.param2.{2} else []"/>
					<set_value name="$RemoveStages" exact="if typeof event.param2 == datatype.list and event.param2.{3}? and typeof event.param2.{3} == datatype.table then event.param2.{3} else []"/>

					<do_if value="$RemoveTargets.count == 0 and typeof $RemoveStages == datatype.list">
						<do_if value="true" comment="Architect (re)build parts twice?">
							<set_value name="$classes" exact="[class.production, class.storage, class.buildmodule]"/>
							<do_all exact="$classes.count" counter="$y">
								<find_object_component name="$PossibleElements" object="$theObject" class="$classes.{$y}" checkoperational="false" multiple="true" />
								
								<add_player_choice	text="'Do %1 [%2]'.[$classes.{$y}, $PossibleElements.count]" position="$y" section="mmcareEC_do_remove" choiceparam="[1, $PossibleElements]" chance="if $PossibleElements.count then 100 else 0"/>
	
								<remove_value name="$PossibleElements" />
							</do_all>
							<remove_value name="$classes" />
						</do_if>

						<find_object_component name="$PossibleElements" object="$theObject" checkoperational="false" multiple="true">
							<match_buildsource sequence="''" stage="0" negate="true" />
						</find_object_component>
						<set_value name="$todo_BP" exact="table[]" />
						<do_all exact="$ABC.count" counter="$Counter">
							<do_if value="$todo_BP.{'$%1'.[$ABC.{$Counter}]}?" negate="true">
								<set_value name="$todo_BP.{'$%1'.[$ABC.{$Counter}]}" exact="[]" />
							</do_if>
						</do_all>
						<do_all exact="$PossibleElements.count" counter="$y">
							<set_value name="$tmpSequence" exact="if typeof $PossibleElements.{$y} == datatype.component then $PossibleElements.{$y}.sequence else $PossibleElements.{$y}.component.sequence" />
							<set_value name="$tmpStage" exact="if typeof $PossibleElements.{$y} == datatype.component then $PossibleElements.{$y}.stage else $PossibleElements.{$y}.component.stage" />
							<do_if value="$todo_BP.{'$%1'.[$tmpSequence]}? and $todo_BP.{'$%1'.[$tmpSequence]}.{$tmpStage}?">
								<do_if value="$todo_BP.{'$%1'.[$tmpSequence]}.{$tmpStage}" negate="true">
									<set_value name="$todo_BP.{'$%1'.[$tmpSequence]}.{$tmpStage}" exact="$tmpStage" />
								</do_if>
								<continue />
							</do_if>
							<do_elseif value="not $todo_BP.{'$%1'.[$tmpSequence]}?">
								<set_value name="$todo_BP.{'$%1'.[$tmpSequence]}" exact="[]" />
								<do_all exact="$tmpStage" counter="$Counter">
									<do_if value="$todo_BP.{'$%1'.[$tmpSequence]}.{$tmpStage}?" negate="true">
										<append_to_list name="$todo_BP.{'$%1'.[$tmpSequence]}" exact="if $tmpStage == $Counter then $tmpStage else false"/>
									</do_if>
								</do_all>
							</do_elseif>
							<do_else>
								<do_if value="$ABC.indexof.{$tmpSequence}">
									<remove_value name="$ABC.{$ABC.indexof.{$tmpSequence}}" />
								</do_if>
								<do_all exact="$tmpStage" counter="$Counter">
									<do_if value="$todo_BP.{'$%1'.[$tmpSequence]}.{$tmpStage}?" negate="true">
										<append_to_list name="$todo_BP.{'$%1'.[$tmpSequence]}" exact="if $tmpStage == $Counter then $tmpStage else false"/>
									</do_if>
								</do_all>
							</do_else>
						</do_all>
						<do_all exact="$ABC.count" counter="$Counter">
							<do_if value="$todo_BP.{'$%1'.[$ABC.{$Counter}]}.count == 0">
								<remove_value name="$todo_BP.{'$%1'.[$ABC.{$Counter}]}" />
							</do_if>
						</do_all>
						<remove_value name="$tmpStage" />
						<remove_value name="$tmpSequence" />
						<remove_value name="$PossibleElements" />
						<add_player_choice		text="'Buildstages'"  	position="4" 	 section="mmcareEC_do_remove" choiceparam="[1, null, $todo_BP]" selectable="$todo_BP.keys.list.count"/>
						<add_player_choice		text="'Full Station'"  	position="5" 	 section="mmcareEC_do_element_remove" choiceparam="[null, null, null, 'remove']"/>
						<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back"/>
						<remove_value name="$todo_BP" />
					</do_if>
					<do_elseif value="typeof $RemoveStages == datatype.table" >
						<set_value name="$todo_options_start" exact="event.param2.{1}" />
						<set_value name="$todo_options_key" exact="if event.param2.{4}? then event.param2.{4} else null" />
						<set_value name="$todo_options_max" exact="$RemoveStages.keys.list.count" />

						<do_if value="$todo_options_key">
							<set_value name="$todo_options_max" exact="$RemoveStages.{$todo_options_key}.count" />
							<do_all exact="6" counter="$i">
								<do_if value="$i == 6 and ($todo_options_start + 1) le $todo_options_max">
									<add_player_choice_sub 		text="{2802,1300}.[$todo_options_start, $todo_options_max]" position="bottom_right" section="mmcareEC_do_remove" choiceparam="[$todo_options_start, null, $RemoveStages, $todo_options_key]"/>
								</do_if>
								<do_elseif value="$todo_options_start le $todo_options_max">
									<set_value name="$tmpKeyID" exact="$todo_options_key" />
									<do_all exact="$ABC.count" counter="$Counter">
										<do_if value="'$%1'.[$ABC.{$Counter}]" exact="$todo_options_key">
											<set_value name="$tmpKeyID" exact="$ABC.{$Counter}" />
											<break />
										</do_if>
									</do_all>
									<find_object_component name="$PossibleElements" object="$theObject" class="[class.production, class.storage, class.buildmodule, class.radar]" checkoperational="false" multiple="true">
										<match_buildsource sequence="$tmpKeyID" stage="$RemoveStages.{$todo_options_key}.{$todo_options_start}" />
									</find_object_component>
									<set_value name="$text" exact="''" />
									<set_value name="$text2" exact="''" />
									<set_value name="$text3" exact="''" />
									<do_all exact="$PossibleElements.count" counter="$Counter">
										<do_if value="$PossibleElements.{$Counter}.name and $PossibleElements.{$Counter}.isclass.storage">
											<set_value name="$text2" exact="'%1%2'.[if $text2 != '' then '\n' else '', $PossibleElements.{$Counter}.name]" operation="add"/>
										</do_if>
										<do_elseif value="$PossibleElements.{$Counter}.name">
											<set_value name="$text" exact="'%1%2'.[if $text != '' then '\n' else '', $PossibleElements.{$Counter}.name]" operation="add"/>
										</do_elseif>
										<do_else>
											<set_value name="$text3" exact="'%1%2'.[if $text3 != '' then '\n' else '', $PossibleElements.{$Counter}.isclass]" operation="add"/>
										</do_else>
									</do_all>
									<remove_value name="$PossibleElements" />
	
									<add_player_choice text="'Remove Seq:%1 Stage:%2'.[$tmpKeyID, $RemoveStages.{$todo_options_key}.{$todo_options_start}]" tooltip="if $text != '' and $text2 != '' then ($text +'\n'+$text2) else if $text != '' then $text else if $text2 != '' then $text2 else $text3" position="$i" section="mmcareEC_do_element_remove" choiceparam="[null, $tmpKeyID, $RemoveStages.{$todo_options_key}.{$todo_options_start}]"/>
									<remove_value name="$text" />
									<remove_value name="$text2" />
									<remove_value name="$text3" />
									<remove_value name="$tmpKeyID" />
									<set_value name="$todo_options_start"  operation="add" exact="1" /> 
								</do_elseif>
								<do_elseif value="$i == 6">
									<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back"/>
								</do_elseif>
							</do_all>
						</do_if>
						<do_elseif value="$todo_options_key" negate="true">
							<do_all exact="6" counter="$i">
								<do_if value="$i == 6 and ($todo_options_start + 1) le $todo_options_max">
									<add_player_choice_sub 		text="{2802,1300}.[$todo_options_start, $todo_options_max]" position="bottom_right" section="mmcareEC_do_remove" choiceparam="[$todo_options_start, null, $RemoveStages, $RemoveStages.keys.list.{$todo_options_start}]"/>
								</do_if>
								<do_elseif value="$todo_options_start le $todo_options_max">
									<set_value name="$tmpKeyID" exact="$RemoveStages.keys.list.{$todo_options_start}" />
									<do_all exact="$ABC.count" counter="$Counter">
										<do_if value="'$%1'.[$ABC.{$Counter}]" exact="$RemoveStages.keys.list.{$todo_options_start}">
											<set_value name="$tmpKeyID" exact="$ABC.{$Counter}" />
											<break />
										</do_if>
									</do_all>
	
									<add_player_choice text="'Seq:%1 Stages:%2'.[$tmpKeyID, $RemoveStages.{$RemoveStages.keys.list.{$todo_options_start}}.max]" section="mmcareEC_do_remove" choiceparam="[1, null, $RemoveStages, $RemoveStages.keys.list.{$todo_options_start}]"/>
									<remove_value name="$tmpKeyID" />
									<set_value name="$todo_options_start"  operation="add" exact="1" /> 
								</do_elseif>
								<do_elseif value="$i == 6">
									<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back"/>
								</do_elseif>
							</do_all>
						</do_elseif>
						<do_else>
							<do_all exact="6" counter="$i">
								<do_if value="$i == 6 and ($todo_options_start + 1) le $todo_options_max">
									<add_player_choice_sub 		text="{2802,1300}.[$todo_options_start, $todo_options_max]" position="bottom_right" section="mmcareEC_do_remove" choiceparam="[$todo_options_start, null, $RemoveStages]"/>
								</do_if>
								<do_elseif value="$todo_options_start le $todo_options_max">
									<set_value name="$tmpKeyID" exact="$RemoveStages.keys.list.{$todo_options_start}" />
									<do_all exact="$ABC.count" counter="$Counter">
										<do_if value="'$%1'.[$ABC.{$Counter}]" exact="$RemoveStages.keys.list.{$todo_options_start}">
											<set_value name="$tmpKeyID" exact="$ABC.{$Counter}" />
											<break />
										</do_if>
									</do_all>
									<find_object_component name="$PossibleElements" object="$theObject" class="[class.production, class.storage, class.buildmodule, class.radar]" checkoperational="false" multiple="true">
										<match_buildsource sequence="$tmpKeyID" stage="$RemoveStages.{$RemoveStages.keys.list.{$todo_options_start}}.max" />
									</find_object_component>
									<set_value name="$text" exact="''" />
									<set_value name="$text2" exact="''" />
									<set_value name="$text3" exact="''" />
									<do_all exact="$PossibleElements.count" counter="$Counter">
										<do_if value="$PossibleElements.{$Counter}.name and $PossibleElements.{$Counter}.isclass.storage">
											<set_value name="$text2" exact="'%1%2'.[if $text2 != '' then '\n' else '', $PossibleElements.{$Counter}.name]" operation="add"/>
										</do_if>
										<do_elseif value="$PossibleElements.{$Counter}.name">
											<set_value name="$text" exact="'%1%2'.[if $text != '' then '\n' else '', $PossibleElements.{$Counter}.name]" operation="add"/>
										</do_elseif>
										<do_else>
											<set_value name="$text3" exact="'%1%2'.[if $text3 != '' then '\n' else '', $PossibleElements.{$Counter}.isclass]" operation="add"/>
										</do_else>
									</do_all>
									<remove_value name="$PossibleElements" />
	
									<add_player_choice text="'Do Seq:%1 Stage:%2'.[$tmpKeyID, $RemoveStages.{$RemoveStages.keys.list.{$todo_options_start}}.max]" tooltip="if $text != '' and $text2 != '' then ($text +'\n'+$text2) else if $text != '' then $text else if $text2 != '' then $text2 else $text3" position="$i" section="mmcareEC_do_element_remove" choiceparam="[null, $tmpKeyID, $RemoveStages.{$RemoveStages.keys.list.{$todo_options_start}}.max]"/>
									<remove_value name="$text" />
									<remove_value name="$text2" />
									<remove_value name="$text3" />
									<remove_value name="$tmpKeyID" />
									<set_value name="$todo_options_start"  operation="add" exact="1" /> 
								</do_elseif>
								<do_elseif value="$i == 6">
									<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back"/>
								</do_elseif>
							</do_all>
						</do_else>

						<remove_value name="$todo_options_key"/>
						<remove_value name="$todo_options_start"/>
						<remove_value name="$todo_options_max"/>
					</do_elseif>
					<do_else>
						<set_value name="$todo_options_start" exact="event.param2.{1}" />
						<set_value name="$todo_options_max" exact="$RemoveTargets.count" />

						<do_all exact="6" counter="$i">
							<do_if value="$i == 6 and ($todo_options_start + 1) le $todo_options_max">
								<add_player_choice_sub 		text="{2802,1300}.[$todo_options_start, $todo_options_max]" 	position="bottom_right" section="mmcareEC_do_remove" 		choiceparam="[$todo_options_start, $RemoveTargets]"/>
							</do_if>
							<do_elseif value="$todo_options_start le $todo_options_max">
								<add_player_choice		text="'Do %1'.[$RemoveTargets.{$todo_options_start}.name]" tooltip="'Seq:%1 Stage:%2'.[if typeof $RemoveTargets.{$todo_options_start} == datatype.component then $RemoveTargets.{$todo_options_start}.sequence else $RemoveTargets.{$todo_options_start}.component.sequence, if typeof $RemoveTargets.{$todo_options_start} == datatype.component then $RemoveTargets.{$todo_options_start}.stage else $RemoveTargets.{$todo_options_start}.component.stage]" 	position="$i" 	 section="mmcareEC_do_element_remove" choiceparam="$RemoveTargets.{$todo_options_start}"/>
								<set_value name="$todo_options_start"  operation="add" exact="1" /> 
							</do_elseif>
							<do_elseif value="$i == 6">
								<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back"/>
							</do_elseif>
						</do_all>
						<remove_value name="$todo_options_start"/>
						<remove_value name="$todo_options_max"/>
					</do_else>
					<remove_value name="$RemoveTargets"/>
					<remove_value name="$RemoveStages"/>
					<remove_value name="$ABC"/>
				</do_if>
				<do_elseif value="$listComp?">
					<set_value name="$classes" exact="[class.jumpdrive, class.engine, class.dronelaunchpad, class.radar]"/>
					<do_if value="event.object.$work?">
						<do_all exact="$classes.count" counter="$y">
							<find_object_component name="$PossibleElements" object="$listComp" class="$classes.{$y}" checkoperational="false" multiple="true">
							  <match_any>
								<match restorable="true" comment="wrecked"/>
								<match repairable="true" invulnerable="false">
								  <match_hull min="75" negate="true" />
								</match>
							  </match_any>
							</find_object_component>

							<find_object_component name="$working" object="$listComp" class="$classes.{$y}" checkoperational="true" min="1">
							  <match_any>
								<match repairable="false" invulnerable="false">
								  <match_hull min="26" />
								</match>
								<match repairable="true" invulnerable="false">
								  <match_hull min="26" />
								</match>
							  </match_any>
							</find_object_component>

							<set_value name="$tmpE" exact="null"/>
							<set_value name="$tmpWreckChance" exact="if $working then 100 else 0"/>
							<do_all exact="$PossibleElements.count" counter="$i">
								<do_if value="$tmpE == null">
									<set_value name="$tmpE" exact="$PossibleElements.{$i}"/>
								</do_if>
								<do_elseif value="$PossibleElements.{$i}.iswreck" chance="$tmpWreckChance">
									<set_value name="$tmpE" exact="$PossibleElements.{$i}"/>
								</do_elseif>
								<do_elseif value="$PossibleElements.{$i}.hullpercentage lt $tmpE.hullpercentage" chance="$tmpWreckChance">
									<set_value name="$tmpE" exact="$PossibleElements.{$i}"/>
								</do_elseif>
								<do_elseif value="$PossibleElements.{$i}.hullpercentage gt $tmpE.hullpercentage">
									<set_value name="$tmpE" exact="$PossibleElements.{$i}"/>
								</do_elseif>
								<do_if value="$tmpE and $tmpE.iswreck" chance="$tmpWreckChance">
									<break />
								</do_if>
							</do_all>
							
							<add_player_choice	text="'Do %1'.[$classes.{$y}]" position="$y" tooltip="if $tmpE and event.object.$work.$element.exists and event.object.$work.$element.iswreck and event.object.$work.$elementTime? and event.object.$work.$elementTime gt player.age then 'time to restore %1 Min'.[if (event.object.$work.$elementTime - player.age)i gt 1 then ((event.object.$work.$elementTime - player.age) / 60s)i] else ''" selectable="$tmpE and event.object.$work.$element != $tmpE" section="mmcareEC_do_element" choiceparam="$tmpE" immediate="$tmpE and $tmpE.iswreck and not $working"/>
						</do_all>
					</do_if>
					<do_else>
						<do_all exact="$classes.count" counter="$y">
							<find_object_component name="$PossibleElements" object="$listComp" class="$classes.{$y}" checkoperational="false" multiple="true">
							  <match_any>
								<match restorable="true" comment="wrecked"/>
								<match repairable="true" invulnerable="false">
								  <match_hull min="75" negate="true" />
								</match>
							  </match_any>
							</find_object_component>

							<find_object_component name="$working" object="$listComp" class="$classes.{$y}" checkoperational="true" min="1">
							  <match_any>
								<match repairable="false" invulnerable="false">
								  <match_hull min="26" />
								</match>
								<match repairable="true" invulnerable="false">
								  <match_hull min="26" />
								</match>
							  </match_any>
							</find_object_component>

							<set_value name="$tmpE" exact="null"/>
							<set_value name="$tmpWreckChance" exact="if $working then 100 else 0"/>
							<do_all exact="$PossibleElements.count" counter="$i">
								<do_if value="$tmpE == null">
									<set_value name="$tmpE" exact="$PossibleElements.{$i}"/>
								</do_if>
								<do_elseif value="$PossibleElements.{$i}.iswreck" chance="$tmpWreckChance">
									<set_value name="$tmpE" exact="$PossibleElements.{$i}"/>
								</do_elseif>
								<do_elseif value="$PossibleElements.{$i}.hullpercentage lt $tmpE.hullpercentage" chance="$tmpWreckChance">
									<set_value name="$tmpE" exact="$PossibleElements.{$i}"/>
								</do_elseif>
								<do_elseif value="$PossibleElements.{$i}.hullpercentage gt $tmpE.hullpercentage">
									<set_value name="$tmpE" exact="$PossibleElements.{$i}"/>
								</do_elseif>
								<do_if value="$tmpE and $tmpE.iswreck" chance="$tmpWreckChance">
									<break />
								</do_if>
							</do_all>
							
							<add_player_choice	text="'Do %1'.[$classes.{$y}]" position="$y" selectable="$tmpE" section="mmcareEC_do_element" choiceparam="$tmpE" immediate="$tmpE and $tmpE.iswreck and not $working"/>
						</do_all>
					</do_else>
					<remove_value name="$tmpWreckChance" />
					<remove_value name="$PossibleElements" />
					<remove_value name="$working" />
					<remove_value name="$tmpE" />
					<remove_value name="$classes" />
					<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back"/>
				</do_elseif>

				<do_if value="$menue?" chance="if event.object.$hacked? and event.object.$hacked gt player.age then 0 else 100">
					<!-- select Object -->
					<add_player_choice_sub text="'Repair selection'" position="4" selectable="not event.object.$work? or event.object.$work.$object == $theObject" section="mmcareEC_do_work" choiceparam="$theObject" chance="if event.object.$destruct? then 0 else 100"/>
					<add_player_choice_sub text="'Destruction'" position="1" selectable="not event.object.$destruct?" tooltip="if event.object.$work? and event.object.$work.$object then event.object.$work.$object.name else ''" section="mmcareEC_do_remove" choiceparam="$theObject" chance="if $theObject.tradenpc.exists or $theObject.defencenpc.exists then 0 else 0" />
				</do_if>
				<remove_value name="$menue" />
				<remove_value name="$theObject" />
				<remove_value name="$listComp" />
			</actions>
		</cue>
		<!--
		<set_value name="$oldShip" exact="event.param2.{1}"/>
		<set_value name="$theShip" exact="event.param2.{2}"/>
		<include_actions ref="md.MM_Care.MM_Care_restore_do" />
		<remove_value name="$theShip" />
		<remove_value name="$Ship" />
		-->
		<library name="MM_Care_restore_do">
			<actions>
				<set_value name="$Macro" exact="if $oldShip.exists then $oldShip.macro else null"/>
				<set_value name="$Position" exact="if $oldShip.exists then $oldShip.position else null"/>
				<set_value name="$Rotation" exact="if $oldShip.exists then $oldShip.rotation else null"/>
				<set_value name="$Zone" exact="if $oldShip.exists then $oldShip.zone else $theShip.zone"/>
				<set_value name="$breakupChance" exact="210"/>
				<set_value name="$breakupChance" exact="20" operation="add" chance="if $Macro.class == class.ship_xl then 100 else 0"/>
				<set_value name="$breakupChance" exact="$theShip.pilot.combinedskill" operation="subtract" chance="if $theShip.pilot and $theShip.pilot.exists then 100 else 0"/>
				<set_value name="$breakupChance" exact="$theShip.engineer.combinedskill" operation="subtract" chance="if $theShip.engineer and $theShip.engineer.exists then 100 else 0"/>
				<set_value name="$breakupChance" exact="$theShip.architect.combinedskill" operation="subtract" chance="if $theShip.architect and $theShip.architect.exists then 100 else 0"/>
				
				<do_if value="$oldShip.exists" negate="true">
					<show_help position="8" log="true" force="true" duration="5s" custom="'ERROR: Wrack not exists anymore in %1'.[$Zone.knownname]" />
				</do_if>
				<do_elseif value="true" chance="[100, $breakupChance].min">
					<do_if value="md.$mmcareWrecks?" negate="true">
						<create_list name="md.$mmcareWrecks"/>
					</do_if>
					<do_if value="md.$mmcareWrecks.indexof.{$oldShip}" negate="true">
						<append_to_list name="md.$mmcareWrecks" exact="$oldShip" />
					</do_if>
					<show_help position="8" log="true" force="true" duration="5s" custom="'INFO: Repair of %1 not possible in %2'.[$oldShip.knownname, $oldShip.zone.knownname]" />
					
					<!-- TODO: Target got destroyed at salvage -->
					<!-- TODO: Recycling Option (Shippart) -->
				</do_elseif>
				<do_else>
					<destroy_object object="$oldShip" explosion="false" />

					<create_ship name="$Ship" macro="$Macro" zone="$Zone">
						<defence actor="null"/>
						<engineer actor="null"/>
						<owner exact="faction.ownerless"/>
						<position value="$Position"/>
						<rotation value="$Rotation"/>
					</create_ship>
					<set_value name="$tags" exact="[tag.turret_small_mg, tag.turret_small_sg, tag.turret_medium_pe, tag.turret_medium_lb, tag.turret_medium_sp, tag.turret_missile_df, tag.turret_missile_sm, tag.shieldgenerator]"/>
					<do_if value="md.$LostSectors? and md.$LostSectors">
						<set_value name="$tags_ls" exact="['turret_small_bor','turret_small_ter','turret_small_ls_ter','turret_medium_ls_ter','turret_medium_bor','turret_medium_par','turret_large_ls_ter','turret_small_sp','turret_small_te']"/><!-- 'turret_small_ls_ter' -->
						<do_all exact="$tags.count" counter="$i">
							<append_to_list name="$tags" exact="tag.{$tags_ls.{$i}}" />
						</do_all>
					</do_if>
					<do_all exact="$tags.count" counter="$i">
						<upgrade_object_by_tag object="$Ship" tag="$tags.{$i}" exact="0"/>
					</do_all>
					<remove_value name="$tags" />

					<create_group groupname="$Objects"/>
					<find_object_component groupname="$Objects" object="$Ship" class="class.destructible" multiple="true" invulnerable="false" functional="true" integrated="false"/>
					<do_all exact="$Objects.list.count" counter="$Counter">
						  <destroy_object object="$Objects.list.{$Counter}" explosion="true" chance="($Objects.list.{$Counter} != $Ship and not $Objects.list.{$Counter}.isclass.dockingbay and not $Objects.list.{$Counter}.macro.ismacro.playerdock_capship01_macro)*100"/>
					</do_all>
					<clear_group group="$Objects"/>
					<find_object_component groupname="$Objects" object="$Ship" multiple="true" invulnerable="false" chance="0">
						<match invulnerable="false" integrated="false" />
						<match_any>
							<match class="class.weapon" />
							<match class="class.engine" />
							<match class="class.shieldgenerator" />
						</match_any>
					</find_object_component>
					<do_all exact="$Objects.list.count" counter="$Counter">
						  <set_object_hull object="$Objects.list.{$Counter}" exact="0"/>
					</do_all>
					<remove_value name="$Objects"/>
					<set_object_shield object="$Ship" exact="0"/>
					<set_object_hull object="$Ship" exact="5"/>
				</do_else>
				<remove_value name="$Macro" />
				<remove_value name="$Position" />
				<remove_value name="$Rotation" />
				<remove_value name="$Zone" />
				<remove_value name="$breakupChance" />
				<remove_value name="$oldShip" />
			</actions>
		</library>
	</cues>
</mdscript>