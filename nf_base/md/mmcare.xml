<?xml version="1.0" encoding="utf-8"?>

<mdscript name="MM_Care" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
	<cues>

		<cue name="SectionHandler_MM_Care_pilot" instantiate="true" >
			<conditions>
				<check_any>
					<event_conversation_next_section section="mmadvcom_main" />
					<event_conversation_returned_to_section section="mmadvcom_main" />
					<event_conversation_next_section sectionprefix="mmcare_do" />
				</check_any>
				<check_value value="event.object.trueowner" exact="faction.player" />
				<check_any>
					<check_value value="event.object.type" exact="entitytype.pilot" />
					<check_value value="event.object.type" exact="entitytype.commander" />
				</check_any>
				<check_value value="event.object.iscontrolentity" />
				<check_value value="event.object.ship.primarypurpose" exact="objectpurpose.fight" negate="true" />
				<check_value value="event.object.container.units.{unitcategory.welder}.count" />
			</conditions>
			<actions>
				<do_if value="event.param" exact="'mmcare_do_restore'">
					<find_gravidar_contact name="$RestoreTargets" object="event.object.container" restorable="true" multiple="true">
						<match_distance object="event.object.container" max="event.object.container.maxradarrange"/>
						<match_size min="300m"/>
					</find_gravidar_contact>
					<do_if value="$RestoreTargets.count">
						<set_value name="$todo_options_start" exact="event.param2" />
						<set_value name="$todo_options_max" exact="$RestoreTargets.count" />

						<do_if value="md.$mmcareWrecks?" negate="true">
							<create_list name="md.$mmcareWrecks"/>
						</do_if>
						<do_else>
							<do_all exact="md.$mmcareWrecks.count" counter="$Counter" reverse="true">
								<do_if value="not md.$mmcareWrecks.{$Counter}.exists">
									<remove_value name="md.$mmcareWrecks.{$Counter}" />
								</do_if>
							</do_all>
						</do_else>

						<do_all exact="6" counter="$i">
							<do_if value="$i == 6 and ($todo_options_start + 1) le $todo_options_max">
								<add_player_choice_sub 		text="{2802,1300}.[$todo_options_start, $todo_options_max]" 	position="bottom_right" section="mmcare_do_restore" 		choiceparam="$todo_options_start"/>
							</do_if>
							<do_elseif value="$todo_options_start le $todo_options_max">
								<add_player_choice		text="$RestoreTargets.{$todo_options_start}.macro.name" tooltip="{2802,1330}.[$RestoreTargets.{$todo_options_start}.distanceto.{event.object.container}]" 	position="$i" 	 selectable="md.$mmcareWrecks.indexof.{$RestoreTargets.{$todo_options_start}} == 0"	section="mmcare_do_restore_do" choiceparam="$RestoreTargets.{$todo_options_start}"/>
								<set_value name="$todo_options_start"  operation="add" exact="1" /> 
							</do_elseif>
							<do_elseif value="$i == 6">
								<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back"/>
							</do_elseif>
						</do_all>
					</do_if>
					<do_else>
						<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back" />
					</do_else>
					<remove_value name="$RestoreTargets"/>
					<remove_value name="$todo_options_start"/>
					<remove_value name="$todo_options_max"/>
				</do_if>
				<do_elseif value="event.param" exact="'mmcare_do_restore_do'">
					<create_group groupname="$docks" />
					<do_if value="global.$mmcarriers_xl? and event.object.container.macro.ismacro.{global.$mmcarriers_xl}">
						<do_all exact="2" counter="$j">
							<find_dock_location container="event.object.container" size="[tag.dock_xl, tag.dock_l].{$j}" name="$dock" multiple="true"/>
							<do_all exact="$dock.count" counter="$i">
								<do_if value="$docks.indexof.{$dock.{$i}.component} == 0 and not ($dock.{$i}.component.external and $dock.{$i}.component.docked.count)">
									<add_to_group groupname="$docks" object="$dock.{$i}.component" />
								</do_if>
								<do_else>
									<continue />
								</do_else>
							</do_all>
							<remove_value name="$dock"/>
						</do_all>
						<add_player_choice text="{2802,8200}" position="top_left" section="mmca_salvage_restore" choiceparam="[null, null, event.param2, true, 'engineer.ai.plus2']" comment="Dock Ships" selectable="$docks.count" />
						<add_player_choice text="{2802,8202}" position="left" section="mmca_salvage_restore" choiceparam="[null, null, event.param2, false, 'engineer.ai.plus2']" comment="Dock Ships" selectable="$docks.count" />
						<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back" />

						<remove_value name="$docks"/>
					</do_if>
					<do_else>
						<set_value name="$oldShip" exact="event.param2"/>
						<set_value name="$theShip" exact="event.object.container"/>
	
						<include_actions ref="md.MM_Care.MM_Care_restore_do" />

						<do_if value="$Ship? and $Ship.exists and $Ship.isclass.ship">
							<remove_from_player_squad object="$theShip" />
							<do_if value="$Ship.isclass.[class.ship, class.station]">
								<start_script name="'move.patrol.care'" object="$theShip.pilot">
									<param name="patrolobject" value="$Ship" />
								</start_script>
							</do_if>
						</do_if>
						<do_else>
							<!-- nothing -->
						</do_else>
						<remove_value name="$Ship" />
						<remove_value name="$theShip" />
					</do_else>

				</do_elseif>
				<!--do_elseif value="event.param" exact="'mmcare_do_restore_do_old'">

					<set_value name="$oldShip" exact="event.param2"/>
					<set_value name="$theShip" exact="event.object.container"/>

					<include_actions ref="md.MM_Care.MM_Care_restore_do" />

					<do_if value="$theShip.isclass.ship and event.param2.exists">
						<remove_from_player_squad object="$theShip" />
						<do_if value="$theShip.isclass.[class.ship, class.station]">
							<start_script name="'move.patrol.care'" object="$theShip.pilot">
								<param name="patrolobject" value="if $Ship? and $Ship.exists then $Ship else event.param2" />
							</start_script>
						</do_if>
						<do_else>
							<start_script name="'move.patrol.care'" object="$theShip.pilot">
								<param name="range" value="'zone'" />
								<param name="patrolobject" value="event.param2.zone" />
							</start_script>
						</do_else>
					</do_if>
					<do_if value="$Ship? and global.$mmcarriers_xl? and $theShip.macro.ismacro.{global.$mmcarriers_xl}">
						<create_group groupname="$docks" />
						<do_all exact="2" counter="$j">
							<find_dock_location container="$theShip" size="[tag.dock_xl, tag.dock_l].{$j}" name="$dock" multiple="true"/>
							<do_all exact="$dock.count" counter="$i">
								<do_if value="$docks.indexof.{$dock.{$i}.component} == 0 and not ($dock.{$i}.component.external and $dock.{$i}.component.docked.count)">
									<add_to_group groupname="$docks" object="$dock.{$i}.component" />
								</do_if>
								<do_else>
									<continue />
								</do_else>
							</do_all>
							<remove_value name="$dock"/>
						</do_all>
						<add_player_choice text="{2802,8200}" position="top_left" section="mmca_salvage" choiceparam="[null, null, $Ship]" comment="Dock Ships" selectable="$docks.count" />
						<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back" />
					</do_if>
					<remove_value name="$Ship" />
					<remove_value name="$theShip" />
				</do_elseif-->
				<do_elseif value="['mmcare_do_care', 'mmcare_do_pos', 'mmcare_do_pos_plus'].indexof.{event.param} and event.object.ship.primarypurpose == objectpurpose.build and @event.object.ship.buildanchor">
					<do_if value="event.object.container.engineer.exists and (not event.object.container.engineer.$Defensible? or not event.object.container.engineer.$doSupport?)">
						<set_value name="event.object.container.engineer.$doSupport" />
						<start_script object="event.object.container.engineer" name="'engineer.ai.plus2'"/>
					</do_if>
					<do_elseif value="event.object.container.engineer.exists">
						<start_script object="event.object.container.engineer" name="'engineer.ai.plus2'"/>
					</do_elseif>
				</do_elseif>
				<do_elseif value="event.param" list="['mmcare_do_pos', 'mmcare_do_pos_plus']">
					<remove_from_player_squad object="event.object.container" />
					<remove_object_commander object="event.object.container"/>
					<start_script name="'move.patrol.care'" object="event.object.container.pilot">
						<param name="range" value="if event.param2.{3}.isclass.zone then 'zone' else if event.param2.{3}.isclass.cluster then 'cluster' else 'sector'" />
						<param name="patrolobject" value="event.param2.{3}" />
						<param name="position" value="if event.param2.{4}? then position.[event.param2.{4}.{1}, event.param2.{4}.{2}, event.param2.{4}.{3}] else null" />
						<param name="ownstations" value="if event.param == 'mmcare_do_pos_plus' then true else false" />
					</start_script>
				</do_elseif>
				<do_elseif value="event.param" exact="'mmcare_do_care'">
					<do_if value="event.object.container.isclass.[class.ship_l, class.ship_xl]">
						<find_gravidar_contact name="$RestoreTargets" object="event.object.container" restorable="true" multiple="true">
							<match_distance object="event.object.container" max="event.object.container.maxradarrange"/>
							<match_size min="300m"/>
						</find_gravidar_contact>
						<add_player_choice text="{2802,1305}" position="top_right" section="mmcare_do_restore" selectable="$RestoreTargets.count gt 0" choiceparam="1" />
						<remove_value name="$RestoreTargets"/>
					</do_if>
					<add_player_choice text="{2802,1310}" section="gOrders_advancedflytopos" tooltip="{2802,1311}" comment="Fly to position" choiceparam="[0, 0, 'cluster', player.primaryship.cluster, null, null, 'selectposition', ['mmcare_do_pos']]"/>
					<add_player_choice text="{2802,1315}" section="gOrders_advancedflytopos" tooltip="{2802,1316}" comment="Fly to position" choiceparam="[0, 0, 'cluster', player.primaryship.cluster, null, null, 'selectposition', ['mmcare_do_pos_plus']]"/>
				</do_elseif>
				<do_else>
					<do_if value="event.object.ship.primarypurpose == objectpurpose.build and @event.object.ship.buildanchor">
						<add_player_choice_sub text="{2802,1301}" section="mmcare_do_care" choiceparam="1" immediate="event.object.container.engineer.$Defensible?" selectable="event.object.container.engineer.exists" />
					</do_if>
					<do_else>
						<add_player_choice_sub text="{2802,1301}" section="mmcare_do_care" choiceparam="1"  />
					</do_else>
				</do_else>
			</actions>
		</cue>
		<cue name="MM_Care_CheckCarriers" instantiate="true">
			<conditions>
			  <check_any>
				  <event_cue_signalled cue="md.Setup.GameStart"/>
				  <event_game_loaded/>
			  </check_any>
			</conditions>
			<delay max="6s"/>
			<actions>
				<set_value name="global.$mmcare_mmcarrier_is_active" exact="false"/>
				<do_if value="@md.$mmcarrierversion" min="142">
					<do_if value="md.$mmcarrier_on ge player.age - 10s">
						<set_value name="global.$mmcare_mmcarrier_is_active" exact="true"/>
					</do_if>
				</do_if>
			</actions>
		</cue>
		<cue name="MM_Care_AdvCom_work" instantiate="true">
			<conditions>
				<check_any>
					<event_conversation_next_section sectionprefix="mmadvcom_"/>
					<event_conversation_returned_to_section sectionprefix="mmadvcom_" />
				</check_any>
				<check_value value="md.$mm_advcom" exact="'care'" />
			</conditions>
			<actions>

				<do_if value="event.param == 'mmadvcom_main'">
					<add_player_choice 		text="{1002,12025}" 	position="bottom_right" section="mmadvcom_next" />
				</do_if>
				<do_elseif value="event.param == 'mmadvcom_next'">
					<!--add_player_choice 		text="{1002,12025}" 	position="bottom_right" section="mmadvcom_last" />
				</do_elseif>
				<do_elseif value="event.param == 'mmadvcom_last'"-->
					<add_player_choice_sub text="{1002,1051}" tooltip="{1026, 20006}" section="gMain_object" position="right" choiceparam="[0, 0, event.object.ship]" comment="Show Ship Details" />
					<add_player_choice_return text="{1002,20}" position="bottom_right" comment="Back" />
				</do_elseif>

			</actions>
		</cue>	
		<cue name="MM_Care_AdvCom_init" instantiate="true">
			<conditions>
			  <check_any>
				  <event_cue_signalled cue="md.Setup.GameStart"/>
				  <event_game_loaded/>
			  </check_any>
			</conditions>
			<delay max="500ms"/>
			<actions>
				<set_value name="md.$mm_advcom" exact="'care'"/>
			</actions>
		</cue>
		<!--
			<signal_objects object="player.galaxy" param="'learned.something'" param2="[this, ware.inv_virtualseminarnavigation]" />
		-->
		<cue name="MM_Care_restore" instantiate="true" namespace="this">
			<conditions>
				<event_object_signalled object="player.computer" param="'Care.DO.restore'" />
				<check_value value="event.param2? and event.param2.{2}? and event.param2.{1}.exists and event.param2.{1}.iswreck" />
			</conditions>
			<delay min="3s" max="8s"/>
			<actions>
				<set_value name="$oldShip" exact="event.param2.{1}"/>
				<set_value name="$theShip" exact="event.param2.{2}"/>
				<set_value name="$doCollect" exact="if event.param2.{3}? and event.param2.{3} then true else false"/>
				<include_actions ref="md.MM_Care.MM_Care_restore_do" />

				<do_if value="$Ship? and $Ship.exists and $Ship.isclass.ship and $doCollect">
					<find_dock_location container="event.object.container" size="$Ship.docksize" name="$dock" />
					<signal_objects object="$theShip" param="'collect ship'" param2="$Ship" param3="$dock" delay="10s"/>
					<remove_value name="$dock" />
				</do_if>
				<do_elseif value="$Ship? and $Ship.exists and $Ship.isclass.ship and not $doCollect">
					<remove_from_player_squad object="$theShip" />
					<do_if value="$Ship.isclass.[class.ship, class.station]">
						<start_script name="'move.patrol.care'" object="$theShip.pilot">
							<param name="patrolobject" value="$Ship" />
						</start_script>
					</do_if>
				</do_elseif>
				<do_else>
					<signal_objects object="$theShip" param="'stop order'" delay="3s"/>
				</do_else>

				<do_if value="$Ship? and $Ship.exists and $Ship.isclass.ship and $theShip.engineer.exists">
					<signal_objects object="$theShip" param="'engineer.support.this'" param2="$Ship" delay="20s"/>
				</do_if>

				<remove_value name="$doCollect" />
				<remove_value name="$theShip" />
				<remove_value name="$Ship" />
			</actions>
		</cue>
		<!--
		<set_value name="$oldShip" exact="event.param2.{1}"/>
		<set_value name="$theShip" exact="event.param2.{2}"/>
		<include_actions ref="md.MM_Care.MM_Care_restore_do" />
		<remove_value name="$theShip" />
		<remove_value name="$Ship" />
		-->
		<library name="MM_Care_restore_do">
			<actions>
				<set_value name="$Macro" exact="$oldShip.macro"/>
				<set_value name="$Position" exact="$oldShip.position"/>
				<set_value name="$Rotation" exact="$oldShip.rotation"/>
				<set_value name="$Zone" exact="$oldShip.zone"/>
				<set_value name="$breakupChance" exact="210"/>
				<set_value name="$breakupChance" exact="20" operation="add" chance="if $Macro.class == class.ship_xl then 100 else 0"/>
				<set_value name="$breakupChance" exact="$theShip.pilot.combinedskill" operation="subtract" chance="if $theShip.pilot and $theShip.pilot.exists then 100 else 0"/>
				<set_value name="$breakupChance" exact="$theShip.engineer.combinedskill" operation="subtract" chance="if $theShip.engineer and $theShip.engineer.exists then 100 else 0"/>
				
				<do_if value="true" chance="[100, $breakupChance].min">
					<do_if value="md.$mmcareWrecks?" negate="true">
						<create_list name="md.$mmcareWrecks"/>
					</do_if>
					<do_if value="md.$mmcareWrecks.indexof.{$oldShip}" negate="true">
						<append_to_list name="md.$mmcareWrecks" exact="$oldShip" />
					</do_if>
					<show_help position="8" log="false" force="true" duration="5s" custom="'INFO: Repair not possible'" />
					<!-- TODO: Target got destroyed at salvage -->
					<!-- TODO: Recycling Option (Shippart) -->
				</do_if>
				<do_else>
					<destroy_object object="$oldShip" explosion="false" />

					<create_ship name="$Ship" macro="$Macro" zone="$Zone">
						<defence actor="null"/>
						<engineer actor="null"/>
						<owner exact="faction.ownerless"/>
						<position value="$Position"/>
						<rotation value="$Rotation"/>
					</create_ship>
					<set_value name="$tags" exact="[tag.turret_small_mg, tag.turret_small_sg, tag.turret_medium_pe, tag.turret_medium_lb, tag.turret_medium_sp, tag.turret_missile_df, tag.turret_missile_sm, tag.shieldgenerator]"/>
					<do_if value="md.$LostSectors? and md.$LostSectors">
						<set_value name="$tags_ls" exact="['turret_small_bor','turret_small_ter','turret_small_ls_ter','turret_medium_ls_ter','turret_medium_bor','turret_medium_par','turret_large_ls_ter','turret_small_sp','turret_small_te']"/><!-- 'turret_small_ls_ter' -->
						<do_all exact="$tags.count" counter="$i">
							<append_to_list name="$tags" exact="tag.{$tags_ls.{$i}}" />
						</do_all>
					</do_if>
					<do_all exact="$tags.count" counter="$i">
						<upgrade_object_by_tag object="$Ship" tag="$tags.{$i}" exact="0"/>
					</do_all>
					<remove_value name="$tags" />

					<create_group groupname="$Objects"/>
					<find_object_component groupname="$Objects" object="$Ship" class="class.destructible" multiple="true" invulnerable="false" functional="true" integrated="false"/>
					<do_all exact="$Objects.list.count" counter="$Counter">
						  <destroy_object object="$Objects.list.{$Counter}" explosion="true" chance="($Objects.list.{$Counter} != $Ship and not $Objects.list.{$Counter}.isclass.dockingbay and not $Objects.list.{$Counter}.macro.ismacro.playerdock_capship01_macro)*100"/>
					</do_all>
					<clear_group group="$Objects"/>
					<find_object_component groupname="$Objects" object="$Ship" multiple="true" invulnerable="false" chance="0">
						<match invulnerable="false" integrated="false" />
						<match_any>
							<match class="class.weapon" />
							<match class="class.engine" />
							<match class="class.shieldgenerator" />
						</match_any>
					</find_object_component>
					<do_all exact="$Objects.list.count" counter="$Counter">
						  <set_object_hull object="$Objects.list.{$Counter}" exact="0"/>
					</do_all>
					<remove_value name="$Objects"/>
					<set_object_shield object="$Ship" exact="0"/>
					<set_object_hull object="$Ship" exact="5"/>
				</do_else>
				<remove_value name="$Macro" />
				<remove_value name="$Position" />
				<remove_value name="$Rotation" />
				<remove_value name="$Zone" />
				<remove_value name="$breakupChance" />
				<remove_value name="$oldShip" />
			</actions>
		</library>
	</cues>
</mdscript>